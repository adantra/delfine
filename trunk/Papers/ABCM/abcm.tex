%Paper for submission to ABCMs Journal
%Using the ENCIT template just for reference, still have to adapt to ABCM format(where is the Latex template for it?)
%Authors: Bruno G. B. Luna
%         Paulo R. M. Lyra
%         Ramiro B. Willmersdorf
%Date (Start): 02/12/2012

\documentclass[10pt,fleqn,a4paper]{article}
\usepackage{encit2012}
\usepackage{amsmath}
\usepackage[latin1]{inputenc}
\usepackage{calc,excludeonly,graphicx}
\usepackage[onehalfspacing]{setspace}
%\usepackage[color,notcite,notref]{showkeys}
\definecolor{DarkBlue}{rgb}{0,0,0.7} 
\usepackage[pdftex,colorlinks=true, linkcolor=DarkBlue, citecolor=DarkBlue]{hyperref}
\usepackage{threeparttable}

% Bruno: Custom packages
\usepackage{subfigure}
\newtheorem{problem}{Problem}
% Definition for tensors format
\def\mathbi#1{\textbf{\em #1}}

\begin{document}
\hspace{-8.5mm}
\begin{tabular}{||p{\textwidth}}
\begin{center}
\vspace{-4mm}
\title{Automated Modelling of Flow in Porous Media via the Finite Element Method  }
\end{center}
\authors{Bruno G. B. Luna, bruno\_bl@yahoo.com.br} \\
\authors{Paulo R. M. Lyra, prmlyra@padmec.org} \\
\authors{Ramiro B. Willmersdorf, ramiro@willmersdorf.net} \\
\institution{Federal University of Pernambuco (UFPE), Departament of Mechanical Engineering, Cidade Universit\'aria s/n, Recife, PE, Brazil, www.ufpe.br} \\
\\
\abstract{
The simulation of multiphase flows in porous media impose many challenges due to a series of factors as the high anisotropic and heterogeneous media handled in this type of analysis, the coupled elliptic-hyperbolic mathematical nature of the associated Partial Differential Equations (PDEs), the programming of the solution method, among others. This work presents the implementation of a software created using the FEniCs tool for automated low-level code generation and PyAMG for the fully automatic creation of consistent multilevel matrix structures used in Algebraic Multigrid Methods (AMG) to be applied to the numerical solution of porous media flows using the Finite Element Method (FEM). The methods described here are general enough to handle with three-dimensional, heterogeneous and anisotropic problems. Examples are shown and results discussed for two-dimensional problems in homogenous and heterogeneous domains with iso- and anisotropic permeability tensors.}\\
\\
\keywords{\textbf{Keywords:} Automated Code Generation, Oil Reservoir, Porous Media Flow, FEM, Multigrid}\\
\end{tabular}

\section{NOMENCLATURE (TO-DO: WHEN PAPER IS DONE, UPDATE THIS LIST)}

\newcommand\DD{\mathrm{D}}
\newcommand\dd{\mathrm{d}}
\newcommand\vvec{\boldsymbol{v}}

\noindent
\begin{minipage}[b]{\linewidth}
\parbox[b][70mm][t]{0.45\linewidth}{
\begin{supertabular}{l l}
$\mathcal{A}$ & area \\
$c_p$ & constant pressure specific heat \\
$h_h$ & convective heat transfer coefficient \\
$h_m$ & convective mass transfer coefficient \\
$i$ & specific enthalpy \\
$\boldsymbol{j}$ & mass flux \\
$\dot{m}$ & mass flow rate \\
$t$ & time \\
$T$ & temperature \\
$Y$ & dry basis vapor concentration \\
\multicolumn{2}{l}{\textbf{Greek Symbols}} \\
$\rho$ & specific mass or concentration \\
$\epsilon$ & total porosity \\
$\tau$ & period \\
\end{supertabular}
}
\hfill
\parbox[b][70mm][t]{0.45\linewidth}{
\begin{supertabular}{l l}
\multicolumn{2}{l}{\textbf{Subscripts}} \\
$e$ & effective or apparent \\
$in$ & inlet \\
$\max$ & maximum \\
$\min$ & minimum \\
$op$ & operation \\
$out$ & outlet \\
$s$ & solid phase \\
$v$ & water vapor \\
\multicolumn{2}{l}{\bf{Superscripts}} \\
$\ast$ & dimensionless quantity \\
$\sim$ & dry basis \\
\end{supertabular}
}
\end{minipage} \\ \mbox{}

\section{INTRODUCTION}
\label{sc:introduction}
Nowadays, the numerical simulation of fluid flow in porous media is fundamental in many engineering fields, such as in the analysis of groundwater flow and contaminant transport \citep{Bear1992}, management of water and heat in polymer membranes for fuel cells \citep{Matamoros2006} or for the simulation of multiphase flows in petroleum reservoirs \citep{Peaceman1977, Aziz1979,Ewing1983,Carvalho2005,Silva2008}.

The scientific modeling of fluid flow in porous media for the petroleum industry has been done since the 1930's, initially using sand-packed models to understand the production of water in oil reservoirs and the reason why the water-oil rate increases with time. In the late 1930's and 1940's some experiments with electrolytic models were used to model the flow in porous media, as it was already recognized the analogy between electric current and the Darcy flow \citep{Peaceman1990}. All these physical analogs models allowed a deeper insight in the phenomena governing this kind of problem, but it was not just until the advent of the electronic computers that engineers were able to simulate real-world problems as, for example, that of oil reservoirs in 2 and 3 dimensions. 

Parallel to the development of new hardware, there has been a extensive work on computational methods applied to multiphase flow in porous media. The first method used in large scale for solving partial diffential equations (PDE) numerically and still the standard in the petroleum industry is the finite difference method (FDM) \citep{Peaceman1990}. However, this kind of method presents some disadvantages, as the difficulty to handle complex domains, general boundary conditions or variable material properties \citep{Chen2006}, especially when compared to methods adequate to handle with unstructured meshes that have been applied more recently in this area as the finite volume method (FVM) \citep{Carvalho2005, Cordazzo2006} or the finite element method (FEM) \citep{Chen2006}. For the reasons already cited, the last class of method has been used along this work.

A common aspect among all these computational methods is the considerable amount of time necessary for the development of computer programs that implement formulations for general and/or complex cases. Much of this time is spent coding tasks that are common to almost any numerical simulation software, as for example the matrix assembly, I/O data handling or iterative solutions for linear system of equations. The approach of this work to overcome this difficulty was to use the open source tool \emph{FEniCS/DOLFIN} \citep{Logg2010}, which performs a low-level code (in \emph{C++}),  automatized generation based on some high-level code (in \emph{Python}) input, allowing the developer to focus on developing and testing different mathematical and numerical formulations for the problem of interest using a syntax very similar to the one used for the mathematical description of the problem, instead of spending time writing auxiliary code for ``administrative'' tasks.

Moreover, there is a need to reduce the computing time of the program in order to make the simulations feasible in the time-frame of a project. Normally, the most CPU-time consuming part of a simulation is the solution of the linear equation system resulting from the PDE's discretization with a numerical method \citep{Saad2003}. Meanwhile, several techniques are available to solve iteratively this kind of system, each of them with its own advantages and disadvantages in terms of speed and generality, whereas these mentioned features often lead to distinct directions, that is, a method that is extremely fast for one specific type of problem is not general and vice-versa. In this work, we used one method that is believed to couple almost ideally these two features, namely the Multigrid method \citep{Trottenberg2001, Saad2003, Briggs2000}. Nevertheless, these desired characteristics are not obtained without cost, and in this case the main additional difficulties associated with Multigrid methods are the need of a sequence of progressive coarser meshes whose generation can become an issue if not adequately addressed and the use of operators for data transfer among the successive levels. Following the principle of sparing coding time with general tasks and focusing on the problem of interest, we used in this work the open source library \emph{PyAMG} \citep{Bell2008}, which not only performs in an fully automatic way the matrix-sequence generation given an initial mesh, but also allows the use of many different variants of the Algebraic Multigrid Method (AMG), including the classical Ruge-St\"uben and the Smoothed Aggregation (SA) algorithms \citep{Trottenberg2001}.


\section{MATHEMATICAL FORMULATION} 
In this work, we have adopted the classical mathematical formulation proposed in \cite{Peaceman1977} for the simultaneous flow of two immiscible phases in a saturated porous medium. This approach has been used by many researchers \citep{Ewing1983,Chavent1986,Carvalho2005,Silva2008} and has as one of its main characteristics the manipulation of the mass conservation equation using the Darcy law to form a system of a parabolic-elliptic pressure and a parabolic-hyperbolic saturation equations \citep{Carvalho2005}, as opposed to other formulations where the pressure and saturation fields are solved simultaneously in a system of parabolic PDEs \citep{Aziz1979}. 
%Describe briefly Aziz's formulation in the thesis, for comparison purposes

The segregated formulation of Peaceman allows the use of specialized methods capable of exploring mathematical characteristics for each equation of the resulting system. The coupling of the two fields is achieved through the use of a total velocity term.

In order to use the equations presented in this section, it is necessary to adopt some simplifying assumptions \citep{Carvalho2005,Peaceman1977}:
\begin{itemize}
\item Totally saturated porous medium;
\item Incompressible fluids and rocks;
\item Immiscible fluids;
\item Isothermal flow;
\item Darcy law valid for the fluids velocities.
\end{itemize}

Considering the assumption of totally saturated porous medium and the existence of $n$ phases, the constitutive equation for saturation yields:
\begin{equation} \label{eq:eq_const_sat}
\sum_{\alpha=1}^n S_{\alpha} = 1
\end{equation}

Where $\alpha$ represents each phase (in this work, $\alpha = w$ and $o$ for water and oil, respectively) and $S_{\alpha}$ represents the saturation of the phase $\alpha$.
% Describe concepts as effective porosity and volume, and then give definition of saturation in the thesis. 
 
The generalized Darcy law for each phase velocity reads as:
\begin{equation} \label{eq:eq_darcy_general}
\vec{v}_{\alpha} = - \frac{K_{\alpha}}{\mu_{\alpha}} \nabla\left(p_{\alpha} - \rho_{\alpha}g\nabla z \right)
\end{equation}
with $K_{\alpha}$, $\mu_{\alpha}$, $p_{\alpha}$ and $\rho_{\alpha}$ represent the effective permeability, viscosity, pressure and density of phase $\alpha$, whereas $g$ and $z$ representing the gravity acceleration and the displacement in its direction, respectively. The relation between the effective  and absolute permeability $K$ accounts for the influence of one fluid on the other during the flow and is defined as the relative permeability:
\begin{equation} \label{eq:relat_perm}
k_{r\alpha} = \frac{K_{\alpha}}{K} \leq 1
\end{equation}
%Cite models for relative permeability (Chen,Aziz as general, Brooks-Corey as specific)

The conservation equation for each phase is described as \citep{Peaceman1977}:
\begin{equation} \label{eq:cons_eq}
-\nabla \cdot \left(\rho_{\alpha} \vec{v}_{\alpha}\right) + q_{\alpha} =
\frac{\partial \left(\phi \rho_{\alpha} S_{\alpha}\right)}{\partial t} 
\end{equation}

The terms $q_{\alpha}$, $\phi$ and $t$ represent sources/sinks of phase $\alpha$ (e.g., wells), effective porosity of rock and time, respectively. Further, if we consider two phases, a wetting (water) and a non-wetting (oil), combining the Eqs. (\ref{eq:eq_darcy_general}) and (\ref{eq:cons_eq}), and using the definition given in Eq. (\ref{eq:relat_perm}), we obtain the following system of partial differential equations which solve the two-phase flow problem under the assumptions taken:
\begin{subequations} \label{eq:twophase_system}
  \begin{equation} \label{eq:twophase_systema}
\nabla \cdot \left(\frac{\rho_{w}Kk_{rw}}{\mu_{w}} \nabla\left(p_{w} - \rho_{w}g\nabla z \right)\right) + q_{w} =
\frac{\partial \left(\phi \rho_{w} S_{w}\right)}{\partial t} 
  \end{equation}
  \begin{equation} \label{eq:twophase_systemb}
\nabla \cdot \left(\frac{\rho_{o}Kk_{ro}}{\mu_{o}} \nabla\left(p_{o} - \rho_{o}g\nabla z \right)\right) + q_{o} =
\frac{\partial \left(\phi \rho_{o} S_{o}\right)}{\partial t} 
  \end{equation}
\end{subequations}
%Stress that these equations are more general then the ones necessary for our assumptions and that they will be simplified

In Eqs. (\ref{eq:twophase_systema}) and (\ref{eq:twophase_systemb}), the pressure and saturation fields are coupled in both equations. These resemble the heat conduction equation and are therefore expected to act as essentially parabolic. This assertive is not necessarily true and can be assessed by obtaining a pair of equations that are dependent either on pressure or on saturation. The derivation of these equations is presented in the next subsection.

\subsection{Pressure Equation} \label{sc:press_eq}
The approach used to derive the pressure equation is to eliminate the time derivative of the saturation present in Eq. (\ref{eq:twophase_system}). First, the time derivatives are expanded to obtain:
\begin{subequations} \label{eq:twophase_system2}
  \begin{equation} \label{eq:twophase_system2a}
-\nabla \cdot \left(\rho_{w} \vec{v}_{w}\right) + q_{w} =
\rho_{w}S_{w}\frac{\partial \phi}{\partial t} + \phi S_{w} \frac{d\rho_{w}}{d p_{w}} \frac{\partial p_{w}}{\partial t} + \phi\rho_{w}\frac{\partial S_{w}}{\partial t}
  \end{equation}
  \begin{equation} \label{eq:twophase_system2b}
-\nabla \cdot \left(\rho_{o} \vec{v}_{o}\right) + q_{o} =
\rho_{o}S_{o}\frac{\partial \phi}{\partial t} + \phi S_{o} \frac{d\rho_{o}}{d p_{o}} \frac{\partial p_{o}}{\partial t} + \phi\rho_{o}\frac{\partial S_{o}}{\partial t}
  \end{equation}
\end{subequations}

Then, dividing the first equation by $\rho_{w}$ and the second by $\rho_{o}$, considering the assumptions made previously that fluids and rock are both incompressible and finally adding the resulting equations, we obtain:
% This step mentioned in the previous paragraph can be explained in more 'substeps' in the thesis for clarity
\begin{equation} \label{eq:twophase_oneequation}
-\nabla \cdot \vec{v}_{t} + Q_{t} = \phi \frac{\partial \left(S_{w} + S_{o}\right)}{\partial t}
\end{equation}
where $\vec{v}_{t} = \vec{v}_{w} + \vec{v}_{o}$ is the total velocity of the fluid and $Q_{t} = (q_{w}/\rho_{w}) + (q_{o}/\rho_{o})$ is the total volumetric rate. Moreover, considering Eq. (\ref{eq:eq_const_sat}) and rearranging the terms, we obtain the pressure equation for the two-phase flow in porous media:
\begin{equation} \label{eq:pressure_eq_form1}
\nabla \cdot \vec{v}_{t} = Q_{t}
\end{equation}

In order to present the Eq. (\ref{eq:pressure_eq_form1}) in relation to one single pressure variable, we may define an average pressure by:
\begin{equation} \label{eq:average_press}
p_{avg} = \frac{p_{w} + p_{o}} {2}
\end{equation}

Considering the definition of capillary pressure as $p_{c} = p_{o} - p_{w}$, we may express the individual phase pressures as:
% The capillary pressure must be better explained in the thesis, including some classical models for it
\begin{subequations} \label{eq:phase_pressures_cap}
  \begin{equation} \label{eq:phase_pressures_capa}
p_{w} = p_{avg} - \frac{p_{c}}{2}
  \end{equation}
  \begin{equation} \label{eq:phase_pressures_capb}
p_{o} = p_{avg} + \frac{p_{c}}{2}
  \end{equation}
\end{subequations}

We also define the phase mobilities as the relation between relative permeability and fluid viscosity:
\begin{equation} \label{eq:phase_mob}
\lambda_{\alpha} = \frac{k_{r\alpha}}{\mu_{\alpha}}
\end{equation}

Finally, rewriting Eq. (\ref{eq:pressure_eq_form1}) using average and capillary pressures, we obtain after some rearrangement of the terms:
\begin{equation} \label{eq:pressure_eq_form2}
\nabla \cdot \left(-K \left( \left(\lambda_{w} + \lambda{o} \right)\nabla p_{avg} + \frac{\lambda_{w} - \lambda_{o}}{2}\nabla p_{c} - 
\left(\lambda_{w}\rho_{w} + \lambda_{o}\rho_{o} \right)g\nabla z \right) \right) = Q_{t}
\end{equation}

Thus, it can be clearly observed that Eq. (\ref{eq:pressure_eq_form2}), considering the assumptions made previously, has an elliptic nature. A saturation equation can be deduced using similar algebraic manipulation and will complete the coupled pressure-saturation model for two phase (oil-water) fluid flow in porous media. For the present work we will concentrate on the single-phase flow governed by Eq. (\ref{eq:pressure_eq_form2}) and section \ref{sc:num_form} deals with methods to solve this kind of equation.

\subsection{Saturation Equation}
% Traduzir da tese
\label{sc:eq_sat}
A equação de saturação pode ser deduzida usando uma manipulação algébrica similar à utilizada na seção anterior de modo a completar o modelo de pressão-saturação para um escoamento bifásico água-óleo em meios porosos. Para a dedução desta equação faz-se necessário definir qual das fases (molhante ou não-molhante) servirá de referência. Neste trabalho foi escolhida a fase aquosa seguindo a prática usual da literatura \citep{Peaceman1977, Ewing1983, Carvalho2005, Silva2008}.

Consideraremos a princípio que tenha sido obtida uma solução para um caso mais geral representado pela Eq.~(\ref{eq:pressure_eq_form2}), sendo portanto conhecida $p_{avg}$. Logo, as pressões das fases água $(p_{w})$ e óleo $(p_{o})$ podem ser calculadas a partir da Eq.~(\ref{eq:phase_pressures_cap}) e utilizando a Eq.~(\ref{eq:eq_darcy_general}) podemos calcular as velocidades das duas fases, obtendo:
\begin{subequations} \label{eq:phase_velocities}
  \begin{equation} \label{eq:phase_velocitiesa}
\mathbi{v}_{w} = - \mathbi{K}\lambda_{w} \left(\nabla p_{w} - \rho_{w}g\nabla z \right)
  \end{equation}
  \begin{equation} \label{eq:phase_velocitiesb}
\mathbi{v}_{o} = - \mathbi{K}\lambda_{o} \left(\nabla p_{o} - \rho_{o}g\nabla z \right)
  \end{equation}
\end{subequations}

Multiplicando a Eq.~(\ref{eq:phase_velocitiesa}) por $\lambda_{o}$, a Eq.~(\ref{eq:phase_velocitiesb}) por $\lambda_{w}$, subtraindo uma da outra e utilizando a definição de pressão capilar, pode-se obter:
\begin{equation} \label{eq:phase_velocities2}
- \lambda_{w}\mathbi{v}_{o} + \lambda_{o}\mathbi{v}_{w} = \mathbi{K}\lambda_{o}\lambda_{w}\nabla p_{c} - \mathbi{K}\lambda_{o}\lambda_{w}\left(\rho_{o} - \rho_{w}\right)g\nabla z
\end{equation}

Considerando-se ainda as definições de velocidade e mobilidade total, podemos reescrever a equação anterior como:
\begin{equation} \label{eq:phase_velocities3}
\lambda_{t}\mathbi{v}_{w} = \lambda_{w}\mathbi{v}_{t} + \mathbi{K}\lambda_{o}\lambda_{w}\left(\nabla p_{c} + \left(\rho_{w} - \rho_{o}\right)g\nabla z\right)
\end{equation}

Definindo ainda o fluxo fracional da fase $\alpha$ como:
\begin{equation} \label{eq:fracflux}
f_{\alpha} = \frac{\lambda_{\alpha}}{\lambda_{t}}
\end{equation}%
\nomenclature[aff]{$f$}{Fluxo fracional}%
e utilizando-se a seguinte função da saturação para simplificar a notação:
\begin{equation} \label{eq:derivcapsat}
h_{w} = - \frac{\lambda_{o}\lambda_{w}}{\lambda_{t}} \frac{d p_{c}}{d S_{w}}
\end{equation}
podemos obter uma expressão na qual a velocidade da fase água é expressa em função da velocidade total. Substituindo as Eqs. (\ref{eq:fracflux}) e (\ref{eq:derivcapsat}) na Eq.~(\ref{eq:phase_velocities3}) e inserindo esta na Eq.~(\ref{eq:cons_eq}), podemos escrever a seguinte expressão para a saturação da fase água:
\begin{equation} \label{eq:sateq}
\frac{\partial (\phi\rho_{w}S_{w})}{\partial t} = - \nabla\cdot\left(\rho_{w}\left(f_{w}\mathbi{v}_{t} - \mathbi{K}h_{w}\nabla S_{w} + \mathbi{K}\lambda_{o}f_{w}\left(\rho_{w} - \rho_{o}\right)g\nabla z\right)\right) + q_{w}
\end{equation}

Assumindo as hipóteses já mencionadas de rochas e fluidos incompressíveis podemos representar a expressão anterior por:
\begin{equation} \label{eq:sateq2}
\phi\rho_{w}\frac{\partial S_{w}}{\partial t} = - \rho_{w}\nabla\cdot\left(\left(f_{w}\mathbi{v}_{t} - \mathbi{K}h_{w}\nabla S_{w} + \mathbi{K}\lambda_{o}f_{w}\left(\rho_{w} - \rho_{o}\right)g\nabla z\right)\right) + q_{w}
\end{equation}

Além disso, dividindo a Eq. \ref{eq:sateq2} por $\rho_{w}$ e considerando a definição do termo de taxa volumétrica de injeção/produção da fase água $Q_{w} = q_{w}/\rho_{w}$, obtemos:
\begin{equation} \label{eq:sateq3}
\phi\frac{\partial S_{w}}{\partial t} = - \nabla\cdot\left(\left(f_{w}\mathbi{v}_{t} - \mathbi{K}h_{w}\nabla S_{w} + \mathbi{K}\lambda_{o}f_{w}\left(\rho_{w} - \rho_{o}\right)g\nabla z\right)\right) + Q_{w}
\end{equation}


A Eq.~(\ref{eq:sateq3}) permite obter a saturação da fase água em um meio poroso considerando as hipóteses básicas descritas no início deste capítulo. Esta equação apresenta um comportamento essencialmente parabólico-hiperbólico, a não ser que o termo de capilaridade seja desprezível comparado com os termos advectivos, o que é verdade especialmente para casos como na vizinhança de poços ou em áreas do reservatório onde a velocidade total seja alta \citep{Carvalho2005}. Considerando esta última condição como válida e supondo um escoamento horizontal, obtemos a forma simplificada para a saturação da fase água em um meio poroso:
\begin{equation} \label{eq:sateq4}
\phi\frac{\partial S_{w}}{\partial t} = - \nabla\cdot\left(f_{w}\mathbi{v}_{t}\right) + Q_{w}
\end{equation}

A Eq.~(\ref{eq:sateq4}) apresenta características essencialmente hiperbólicas e não-lineares devido ao termo de fluxo fracional. Um modo de estudar os fenômenos principais associados a esta equação é utilizar modelos que isolem apenas algumas das características de interesse. Sendo assim, serão apresentadas a seguir duas variações das equações apresentadas para a saturação. A primeira delas considera um escoamento unidimensional e sem termo de fonte, onde o principal objetivo é analisar o efeito da não-linearidade decorrente do fluxo fracional. A segunda variação considera uma versão linear da Eq.~(\ref{eq:sateq3}), a qual nada mais é do que a conhecida equação de difusão-convecção e que neste caso governa o escoamento multidimensional de fluidos miscíveis \citep{Peaceman1977, Barbosa2009, Loula1995}.

\subsection{Boundary and Initial Conditions}
% Traduzir da tese
\label{sc:cond_ini_bc}
% Garcia / Chen / Shan / Comentarios Ewing
Antes de especificar a formulação numérica utilizada, algumas definições a respeito das condições iniciais, de contorno e hipóteses simplificadoras têm que ser discutidas para tornar o problema abordado completamente determinado.

Os contornos são descritos como $\Gamma = \partial \Omega$ $= \Gamma_{I} \cup$ $\Gamma_{P} \cup$ $\Gamma_{D} \cup$ $\Gamma_{N}, $%
\nomenclature[e1g]{$\Gamma$}{Contorno do domínio $\Omega$}%
\nomenclature[e1o]{$\Omega$}{Domínio espacial do problema}
onde \citep{Carvalho2005}:
% Talvez mudar a ordem passando a descricao acima para junto da parte de discretizacao,
% comecando portanto apenas com a parte referente a formulacao fraca 'analitica'
\begin{itemize}
\item $\Gamma_{I}$ = Poços injetores;
\item $\Gamma_{P}$ = Poços produtores;
\item $\Gamma_{D}$ = Condição de contorno de Dirichlet (Variável prescrita);
\item $\Gamma_{N}$ = Condição de contorno de Neumman (Fluxo prescrito).
\end{itemize}

Usualmente, os poços são tratados como condições de contorno internas, sendo modelados através de métodos especiais para lidar com a velocidade alta nas adjacências de um poço \citep{Peaceman1977} comparada com o resto do domínio. Apesar disso, foi adotada neste trabalho uma hipótese simplificadora considerando que os poços são termos fonte/sumidouros de produção ou injeção concentrados em um único nó da malha, isto é, uma função delta de Dirac neste ponto.

Neste trabalho, foi feita a consideração usual adotada em problemas de reservatório de petróleo \citep{Peaceman1977, Ewing1983} de condição de fluxo zero em todas as fronteiras exteriores do domínio, isto é:
\begin{equation} \label{eq:noflowbc}
\mathbi{K} \lambda p \cdot \mathbi{n} = 0 \quad \textrm{em $\Gamma_{N}$}
\end{equation}
onde $\lambda$ é a mobibilidade total, ou seja, $\lambda = \lambda_{w} + \lambda_{o}$, $p$ é a pressão média ($p = p_{avg}$) e $\mathbi{n}$%
\nomenclature[bnv]{$\mathbi{n}$}{Vetor normal ao contorno}
 é o vetor unitário normal aos contornos externos.
 
Logo, assumindo que a transferência de massa entre o reservatório e o meio externo se dará apenas pelos poços injetores e produtores, temos:
\begin{equation} \label{eq:wellbc}
\left. \begin{array}{lll}
\mathbi{v}_{\alpha} \cdot \mathbi{n} = q^{I}_{\alpha} \quad \textrm{ou} \quad p(\mathbi{x},t) = p^{I} \quad \textrm{em $\Gamma_{I}$} \\
\mathbi{v}_{\alpha} \cdot \mathbi{n} = q^{P}_{\alpha} \quad \textrm{ou} \quad p(\mathbi{x},t) = p^{P} \quad \textrm{em $\Gamma_{P}$} \\
\end{array} \right.
\end{equation}
onde $q_{I}_{\alpha}$ e $q_{P}_{\alpha}$ representam as vazões volumétricas da fase $\alpha$ nos poços injetores e produtores, respectivamente.

As condições inicial e de contorno para a equação de saturação são:
\begin{equation} \label{eq:satinibc}
\left. \begin{array}{lll}
S_{w}(\mathbi{x},0) = S^{t=0}_{w} \quad \textrm{em $\Omega$} \\
S_{w}(\mathbi{x},t) = S^{I}_{w} \quad \textrm{em $\Gamma_{I}$} \\
\mathbi{K} \nabla S_{w}(\mathbi{x},t) \cdot \mathbi{n} = 0 \quad \textrm{em $\Gamma_{N}$}\\
\end{array} \right.
\end{equation}

Para a equação da concentração de um soluto em um fluido solvente, ver Eq.~(\ref{eq:misc1}), as condições iniciais e de contorno são definidas de modo similar:
\begin{equation} \label{eq:coninibc}
\left. \begin{array}{lll}
C(\mathbi{x},0) = C^{t=0} \quad \textrm{em $\Omega$} \\
C(\mathbi{x},t) = \hat{C} \quad \textrm{em $\Gamma_{I}$} \\
\mathbi{D} \nabla C(\mathbi{x},t) \cdot \mathbi{n} = 0 \quad \textrm{em $\Gamma_{N}$}\\
\end{array} \right.
\end{equation}

\section{NUMERICAL FORMULATION} \label{sc:num_form}
The basic idea of almost all numerical methods for the solution of PDEs is the discretization and thereby reduction to a finite number of degrees of freedom (DOFs) of a continuum problem, which possesses a infinite number of DOFs. This discrete problem results in an system of equations with finite number of variables, which can normally be solved using an adequate method (see section \ref{sc:multigrid} for details) \citep{Chen2006}.

In the Finite Difference Method (FDM), which is still the standard for numerical reservoir simulations, the derivatives of the original equations are simply replaced by quotients of differences. The values of the variables are defined only in a specified number of points, which can be located either on the corners or in the interior of the cells \citep{Fortuna2000}.

The discretization process within the Finite Element Method (FEM) is different in that it requires a reformulation of the PDEs in an equivalent variational form. The unknown variable, in this case the pressure, is described at each point of the region using an interpolation function. The support points of these functions are the grid nodes, which are connected forming elements. 

In this work, we experimented with classical Standard Galerkin Finite Element Method. This methodology is briefly described in the following subsections and references are pointed for further informations.

\subsection{Finite Element Method} \label{sc:fem}
% Garcia / Chen / Shan / Comentarios Ewing
Before specifying the numerical formulation that will be used, some definitions regarding the boundary conditions and simplifying assumptions must be discussed.
In this work, we made the usual consideration adopted in petroleum reservoir problems \citep{Peaceman1977, Ewing1983} of no-flow condition on all the external boundaries of the domain, that is:
\begin{equation} \label{noflowbc}
\lambda K \nabla p \cdot n = 0 \quad \textrm{in $\Gamma_{N}$}
\end{equation}

Where $\lambda$ is the total mobility, that is, $\lambda = \lambda_{w} + \lambda_{o}$, $p$ is the average pressure ($p = p_{avg}$) and $n$ is the unit vector normal to the external boundaries.

The boundaries are described as $\Gamma = \partial \Omega$ $= \Gamma_{I} \cup$ $\Gamma_{P} \cup$ $\Gamma_{D} \cup$ $\Gamma_{N}$, where \citep{Carvalho2005}:
% Talvez mudar a ordem passando a descricao acima para junto da parte de discretizacao,
% comecando portanto apenas com a parte referente a formulacao fraca 'analitica'
\begin{itemize}
\item $\Gamma_{I}$ = Injection Wells;
\item $\Gamma_{P}$ = Production Wells;
\item $\Gamma_{D}$ = Dirichlet Boundary Condition (Prescribed Pressure);
\item $\Gamma_{N}$ = Neumann Boundary Condition (Prescribed Flux).
\end{itemize}

Usually, the wells are treated as internal boundary conditions, being modeled by special methods to deal with the increased velocity in the vicinities of a well \citep{Peaceman1977} compared with the rest of the domain. Despite that, we adopted in this work a simplifying assumption, considering the wells as source/sink terms of injected or produced fluid in a single node of the mesh, that is, a Dirac function in that point. Furthermore, in this work were made the assumptions that the flow is horizontal (no influence of the gravity) and with negligible capillary pressure. This way it was possible to concentrate on the elliptic characteristics of the pressure equation.

In order to solve a problem with the FEM, it is necessary initially to express it in the so-called \emph{weak form}. The first step to obtain this new formulation (also called the variational problem) is to multiply the PDE by a function $w$, called a \emph{test function}, after that the result is integrated over the domain $\Omega$ and finally an integration by parts is performed on terms with second-order derivatives \citep{Hughes2000}. The unknown function (pressure $p$ in this case) is referred to as a \emph{trial function}. Appropriated function spaces must be defined for the test and trial functions.
%Perform the steps above mentioned in a detailed step-by-step presenting the equations
% See Fenics tutorial for reference on that

The variational problem for the pressure equation (Eq. (\ref{eq:pressure_eq_form2})) considering all the mentioned assumptions, has the following form:
\begin{problem} [Continuous]
Find $p$ $\in$ $P$ such that:
\begin{equation} \label{eq:variational}
A(p,w) = f(w) \quad \forall w \in W
\end{equation}
with 
\begin{equation} \label{eq:funcspace1}
P = \{ p \in H^{1}(\Omega), \textrm{$p = p_{D}$ on $\Gamma$} \}  
\end{equation}
\begin{equation} \label{eq:funcspace2}
W = \{ w \in H^{1}(\Omega), \textrm{$w = 0$ on $\Gamma$} \}  
\end{equation}
\begin{equation} \label{eq:bilinearform}
A(p,w) = \int_{\Omega} \lambda K \nabla p \cdot \nabla w d \Omega \quad \forall p,w \in P,W
\end{equation}
\begin{equation} \label{eq:linearform}
f(w) = \int_{\Omega} Q_{t}w d \Omega \quad \forall w \in W
\end{equation}
\end{problem}
where $p_{D}$ is a prescribed value of $p$ on the Dirichlet boundaries and $H^{1}$ is the Sobolev space of functions with square-integrables derivatives of first order. This means that while the PDE solution must lie in a function space with continuous derivatives (\emph{strong form}), the Sobolev space required in the \emph{weak form} allows functions with discontinuous derivatives \citep{Langtangen2010}.
% Explain better about function spaces (Sobolev, L2, etc.). Fenics tutorial good on that
The existence and uniqueness of the solution for this problem are given by the Lax lemma and their full derivation is found in \cite{Garcia1997}.

% Verify the statement about the velocity on well region and the assumptions made for simplification.
For the finite element analysis of this variational problem, we must transform the continuous variational problem defined by Eq. (\ref{eq:variational}) to a discrete one. Consider a domain $\Omega$ which is discretized with $N$ non-overlaping elements $E_{i}$ such that $\Omega_{h} = \bigcup_{i=1}^{N}E_{i}$ and $E_{i} \cap E_{j} = \emptyset, i \not = j$, where the subindex $h$ denotes a mesh size parameter representing the discretized problem.

The discrete variational problem for the pressure equation using the classical Galerkin approach described in \citep{Hughes2000} and adopted in \citep{Wells2008, Barbosa2009} is:
\begin{problem} [Discrete]
Find $p_{h}$ $\in$ $P_{h}$ such that:
\begin{equation} \label{eq:galerkin}
A(p_{h},w_{h}) = f(w_{h}) \quad \forall w_{h} \in W_{h}
\end{equation}
with 
\begin{equation} \label{eq:funcspace1h}
P_{h} = \{ p_{h} \in H^{1}(\Omega_{h}), p_{h} \in \mathbf{P}^{k}(E_{i}), \textrm{$p_{h} = p_{d}$ on $\Gamma$} \}  
\end{equation}
\begin{equation} \label{eq:funcspace2h}
W_{h} = \{ w_{h} \in H^{1}(\Omega_{h}), w_{h} \in \mathbf{P}^{k}(E_{i}), \textrm{$w_{h} = 0$ on $\Gamma$} \}  
\end{equation}
\begin{equation} \label{eq:bilinearformh}
A(p_{h},w_{h}) = \int_{\Omega_{h}} \lambda K \nabla p_{h} \cdot \nabla w_{h} d \Omega \quad \forall p_{h},w_{h} \in P_{h},W_{h}
\end{equation}
\begin{equation} \label{eq:linearformh}
f(w_{h}) = \int_{\Omega_{h}} Q_{t}w_{h} d \Omega \quad \forall w_{h} \in W_{h}
\end{equation}
\end{problem}
where $\mathbf{P}^{k}(E_{i})$ defines Lagrange finite element basis functions of order $k$ on the element $E_{i}$. The Eq. (\ref{eq:galerkin}) above applied to a mesh results in a set of discrete equations on the variable $p$, whose solution is obtained using the methods described in section \ref{sc:multigrid}. 
% Colocar figuras dos elementos triangulares 1st,2nd e 3rd ordem do dolfin-plot

\subsection{Mixed Finite Element Method} \label{sc:mfem}
Na simulação de escoamentos em meios porosos é fundamental se obter uma boa aproximação para a variável de velocidade, pois esta será utilizada para o acoplamento entre as equações de pressão e saturação. Após a utilização de um método numérico como o descrito na seção anterior apenas a variável de pressão estará definida, sendo que esta aproximação será de segunda ordem para elementos triangulares lineares como os que foram usados na maior parte deste trabalho. Portanto, seria necessário calcular em uma etapa seguinte a velocidade a partir da pressão calculada. 

O modo mais direto de fazer isto seria usar diretamente a equação de Darcy (Eq.~(\ref{eq:eq_darcy_general})), a qual permite obter o campo de velocidades a partir do gradiente de pressão. Porém, tal alternativa apresenta as grandes desvantagens de requerer a diferenciação do campo de pressão, diminuindo a ordem de convergência da aproximação e de não garantir a continuidade da velocidade nas fronteiras, já que um campo contínuo linear de pressão terá o seu gradiente representado como descontínuo entre elementos vizinhos. Uma alternativa utilizada por alguns autores \citep{Loula1995, Barbosa2009} é realizar um pós-processamento ao final do cálculo do campo de pressão para se obter um novo problema variacional na variável de velocidade, o qual ao ser resolvido garante uma melhor ordem de aproximação e a continuidade do campo entre os elementos.

Uma outra alternativa, a qual é apresentada nesta seção e utilizada neste trabalho, é o uso de uma formulação mista. A maior motivação para o desenvolvimento e uso do \acf{MEFM} é que em algumas aplicações, como no caso da simulação de escoamentos em meios porosos, uma variável vetorial (ex: velocidade de um fluido) também é de interesse, sendo que os métodos do tipo \ac{MEFM} foram desenvolvidos para aproximar tanto esta variável quanto a escalar (ex: pressão) simultaneamente e fornecer aproximações de alta ordem para ambas as variáveis.

Entretanto, esta vantagem é obtida ao custo de uma maior complexidade da formulação, já que ao invés de um único espaço de elementos finitos o \ac{MEFM} requer dois espaços, os quais \emph{não} podem ser escolhidos arbitrariamente pois têm que satisfazer uma condição do tipo \emph{inf-sup} para serem estáveis \citep{Chen2006}.

Em \cite{Raviart1977} foi proposta a primeira família de espaços de elementos finitos mistos que satisfazem a condição de estabilidade conhecida como \emph{Ladyshenskaja-Babuska-Brezzi Condition} (LBB) (ver \cite{Brezzi1991} para uma discussão detalhada sobre esta condição) para problemas elípticos de 2ª ordem como o representado pela equação da pressão (Eq.~(\ref{eq:pressure_eq_form3})), sendo que, depois desta, várias outras combinações de espaços já foram sugeridos na literatura \citep{Brezzi1985, Chen2006}.

De modo a ilustrar o procedimento para obtenção da forma fraca, consideremos inicialmente a equação da pressão desenvolvida na seção \ref{sc:press_eq}, a qual é reproduzida a seguir, onde os subíndices foram omitidos por questão de clareza:
\begin{equation} \label{eq:pressure_eq_formMFEM}
- \nabla \cdot \left(\mathbi{K} \lambda \nabla p \right) = Q
\end{equation}
sendo que ela está sujeita à condição de fluxo zero em todas as fronteiras exteriores do domínio, conforme explicado na seção \ref{sc:cond_ini_bc}:
\begin{equation} \label{eq:noflowbc}
\mathbi{K} \lambda \nabla p \cdot \mathbi{n} = 0 \quad \textrm{em $\Gamma_{N}$}
\end{equation}

De modo a garantir que a variável vetorial (velocidade $\mathbf{v}$) tenha componentes contínuas em $\Omega$, podemos utilizar um Espaço de Sobolev para funções vetoriais definido por:
\begin{equation} \label{eq:vectorsobolevspace}
\mathbf{H}(div, \Omega) = \{\mathbf{\zeta} = (\zeta_{1}, \zeta_{2}) \in (L_{2}(\Omega)\times L_{2}(\Omega)); \nabla \cdot \mathbf{\zeta} \in L_{2}(\Omega) \}  
\end{equation}

Assim, podemos definir o espaço $\mathbf{V} = \{\mathbf{\zeta} \in \mathbf{H}(div, \Omega); \mathbf{\zeta} \cdot n = 0 \phantom{l} \textrm{em $\Gamma_{N}$} \}$ para garantir a condição de fluxo zero na fronteira e o espaço $W = L_{2}(\Omega)$, onde é importante observar que funções em $W$ não são necessariamente contínuas.

Além disso, definimos a seguinte notação para o produto interno em $L_{2}(\Omega)$:
\begin{equation} \label{eq:innerprod}
(v,w) = \int_{\Omega} v(x)w(x) dx
\end{equation}

Utilizando a definição da velocidade, podemos escrever:
\begin{equation} \label{eq:velocityMFEM}
\mathbf{v} = - \mathbi{K} \lambda \nabla p  
\end{equation}

Logo, a Eq.~(\ref{eq:pressure_eq_formMFEM}) se torna:
\begin{equation} \label{eq:pressure_eq_formMFEM2}
\nabla \cdot \mathbf{v} = Q  
\end{equation}

Multiplicando-se a Eq.~(\ref{eq:velocityMFEM}) por $\zeta \in \mathbf{V}$, passando os termos de permeabilidade e mobilidade para o lado esquerdo da equação e integrando o resultado no domínio, usamos a definição de produto interno da Eq.~(\ref{eq:innerprod}) para obter:
\begin{equation} \label{eq:pressure_eq_formMFEM3}
\left( (\mathbi{K}\lambda)^{-1} \mathbf{v}, \zeta \right) = - (\zeta, \nabla p)
\end{equation}

Aplicando o teorema da divergência no lado direito desta equação, obtemos:
\begin{equation} \label{eq:pressure_eq_formMFEM4}
\left( (\mathbi{K}\lambda)^{-1} \mathbf{v}, \zeta \right) = (\nabla \cdot \zeta, p)
\end{equation}

E multiplicando a Eq.(\ref{eq:pressure_eq_formMFEM2}) por $w \in W$, temos:
\begin{equation} \label{eq:pressure_eq_formMFEM4}
(\nabla \cdot \mathbf{v}, w) = (Q, w)
\end{equation}

De posse de todas estas definições, podemos descrever o problema variacional (\emph{forma fraca}) para as equações de pressão e velocidade do seguinte modo \citep{Chen2006}:
\begin{problem} [Contínuo]
Encontre $p$ $\in$ $W$ e $\mathbf{v}$ $\in$ $\mathbf{V}$ tal que:
\begin{equation} \label{eq:variationalmfem}
A(p,w,\mathbf{v},\zeta) = f(w) \quad \forall \zeta \in \mathbf{V}, \quad \forall w \in W
\end{equation}
com
\begin{equation} \label{eq:funcspace1mfem}
\mathbf{V} = \{\mathbf{\zeta} \in \mathbf{H}(div, \Omega); \mathbf{\zeta} \cdot n = 0 \phantom{l} \textrm{em $\Gamma_{N}$} \}
\end{equation}
\begin{equation} \label{eq:funcspace2mfem}
W = L_{2}(\Omega)
\end{equation}
\begin{equation} \label{eq:bilinearformhmfemch03}
A(p,w,\mathbf{v},\zeta) = \left( (\mathbi{K}\lambda)^{-1} \mathbf{v}, \zeta \right) -(\nabla \cdot \zeta, p) -(\nabla \cdot \mathbf{v}, w)
\end{equation}
\begin{equation} \label{eq:linearformhmfemch03}
f(w) = - (Q, w)
\end{equation}
\end{problem}

De modo a se possibilitar a análise deste problema variacional via \ac{MEFM}, é necessário representar o mesmo na forma discreta. Para isto, precisamos definir espaços finitos que substituam os espaços $\mathbf{V}$ e $\mathbf{W}$ determinados conforme mostrado nas Eqs. (\ref{eq:funcspace1mfem}) e (\ref{eq:funcspace2mfem}). Neste trabalho foi utilizada a combinação conhecida como espaços \ac{BDM} \citep{Brezzi1985}, os quais têm a característica de permitir obter a mesma ordem de convergência do erro para a variável vetorial que os espaços de \emph{Raviart-Thomas} \citep{Raviart1977}, porém com a vantagem de terem uma dimensão menor. Os espaços \ac{BDM} podem ser definidos para cada elemento finito da malha do modo a seguir, considerando um $k \geq 1$ \citep{Chen2006}:
\begin{equation} \label{eq:bdmspaces1}
\mathbf{V}_{h}(E_{i}) = \mathbf{P}^{k}(E_{i}) \times \mathbf{P}^{k}(E_{i})
\end{equation}
\begin{equation} \label{eq:bdmspaces2}
\mathbf{W}_{h}(E_{i}) = \mathbf{P}^{k-1}(E_{i})
\end{equation}

Para o caso mais simples, com $k = 1$, obtemos a seguinte definição para $\mathbf{V}_{h}$ em um triângulo:
\begin{equation} \label{eq:bdmspaces3}
\mathbf{V}_{h}(E_{i}) = \{\mathbf{\zeta}_{h} =  \left( a_{E_{i}}^{1} + a_{E_{i}}^{2}x_{1} + a_{E_{i}}^{3}x_{2}, a_{E_{i}}^{4} + a_{E_{i}}^{5}x_{1} + a_{E_{i}}^{6}x_{2} \right) \}
\end{equation}

Este triângulo é mostrado na Fig.~\ref{fig:mfemtriangles}(a), onde percebe-se que os graus de liberdade em $\mathbf{V}_{h}$ são os valores das componentes normais das funções em dois pontos diferentes para cada aresta do elemento, tendo este espaço portanto uma dimensão igual a seis. Para $k = 1$, o espaço $\mathbf{W}_{h}$ é constante em cada elemento, tendo portanto uma dimensão unitária.
\begin{figure}
\centering
\subfigure[Triângulo de Ordem 1]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri1}
}
\quad
\subfigure[Triângulo de Ordem 2]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri2}
}
\quad
\subfigure[Triângulo de Ordem 3]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri3}
}
\caption[Exemplo de elementos triângulares para análise via MEFM.]{Exemplo de elementos triângulares para análise via \ac{MEFM}.}
\label{fig:mfemtriangles}
\end{figure}
O problema discreto para o \ac{MEFM} pode então ser descrito por:
\begin{problem} [Discreto]
Encontre $p_{h}$ $\in$ $W_{h}$ e $\mathbf{v_{h}}$ $\in$ $\mathbf{V_{h}}$ tal que:
\begin{equation} \label{eq:variationalmfemh}
A(p_{h},w_{h},\mathbf{v_{h}},\zeta_{h}) = f(w_{h}) \quad \forall \zeta_{h} \in \mathbf{V}_{h}, \quad \forall w \in W_{h}
\end{equation}
com
\begin{equation} \label{eq:bilinearformhmfemch03h}
A(p_{h},w_{h},\mathbf{v_{h}},\zeta_{h}) = \left( (\mathbi{K}\lambda)^{-1} \mathbf{v_{h}}, \zeta_{h} \right) -(\nabla \cdot \zeta_{h}, p_{h}) -(\nabla \cdot \mathbf{v_{h}}, w_{h})
\end{equation}
\begin{equation} \label{eq:linearformhmfemch03h}
f(w_{h}) = - (Q_{h}, w_{h})
\end{equation}
\end{problem}

\subsection{MEF Stabilization via SUPG} \label{sc:supg}
O \ac{MEF} de Galerkin permite obter respostas bastantes acuradas para problemas com soluções suaves, como normalmente é o caso para equações essencialmente elípticas como a equação de pressão. Entretanto, ele não se mostra adequado para a simulação de fenômenos dominados por termos advectivos, caso frequente de equações com características hiperbólicas como a equação de saturação descrita em \ref{sc:eq_sat}. Nestes casos a solução pode se tornar instável, sendo que tal instabilidade é transportada para todo o domínio, deteriorando rapidamente a acurácia global.

Mesmo antes do aparecimento deste problema no contexto do \ac{MEF}, ele já era bastante conhecido do estudo do \ac{MDF}, podendo ser explicado em ambos os casos pelo uso de aproximações que se baseiam no uso de discretizações centradas, ou seja, quando as contribuições vindo de todas as direções possuem o mesmo peso na solução. Inicialmente, uma das técnicas para se contornar este tipo de problema era adicionar um termo artificial de difusão diretamente nas \ac{EDP}s que se desejava aproximar \citep{Papastavrou1998}. Todavia, esta técnica apresenta a desvantagem fundamental de alterar a descrição matemática do problema, ocasionando assim uma perda de consistência, já que mesmo que se utilize uma discretização tendendo ao contínuo continuaria-se obtendo uma resposta que não tenderia à analítica. Para alguns problemas tal alternativa é aceitável, pois os termos adicionados são de alta ordem e portanto afetam pouco a consistência. Porém, uma solução mais apropriada seria o uso de termos baseados no resíduo, o que garantiria a consistência para qualquer caso.

Uma solução proposta no contexto do \ac{MDF} consiste na ponderação da solução com um peso maior para a informação que segue o sentido do fluxo (esta técnica é comumente conhecida como \emph{Upwinding}). No caso do \ac{MEF}, \cite{Brooks1982} propuseram um método no qual o espaço da função de ponderação não mais corresponde ao espaço da função tentativa utilizada (ou seja, um método do tipo Petrov-Galerkin), sendo adicionado um termo de perturbação com caráter difusivo que atua apenas na direção da linha de fluxo no nível do elemento. Este método, o qual se tornou conhecido pelo nome de \acf{SUPG}, foi extensamente utilizado na literatura para várias aplicações, inclusive na resolução da equação de saturação em escoamentos multifásicos \citep{Barbosa2009, Garcia1997, Loula1995}. Um exemplo desta função de ponderação modificada tem sua representação gráfica mostrada na Fig.~\ref{fig:supgweightfunc}, onde se considera um fluxo da esquerda para a direita. Pode ser observado claramente na figura o maior peso considerado para o elemento que está a montante do escoamento quando comparado ao que se encontra a jusante. Isto implica que a modificação a ser efetuada na função de ponderação deve de alguma forma ser dependente da direção e sentido do escoamento.

\begin{figure} 
\centering
\includegraphics[width=0.5\textwidth]{chapters/ch03/supgweightfunc}
\caption{Comparação entre diferentes definições da função de ponderação (retirado de \cite{Monajemi2009}).}
\label{fig:supgweightfunc}
\end{figure}

Esta nova função de ponderação para a formulação estabilizada, aqui representada por $w_{s}$, pode ser descrita matematicamente conforme a equação seguinte:
\begin{equation} \label{eq:supgweight}
w_{s} = w + \tau_{s} \mathbf{v} \cdot \nabla w
\end{equation}%
\nomenclature[a1tau]{$\tau$}{Parâmetro de estabilização}%
onde $\mathbf{v}$ representa o vetor velocidade, $w$ a função de ponderação original e $\tau_{s}$ um parâmetro de estabilização que depende do tamanho do elemento e do módulo da velocidade.

Uma vez definida tal função, aplica-se um procedimento semelhante ao utilizado para a discretização pelo Método de Galerkin onde se integra a Eq.~(\ref{eq:sateq4}), desprezando-se aqui o termo de fonte por simplicidade, porém a multiplicação é pela função de ponderação modificada (Eq.~(\ref{eq:supgweight})), para se obter depois de algum algebrismo e de modo consistente a seguinte forma variacional discreta para o problema da equação de saturação \citep{Wells2008}:
\begin{problem} [Discreto]
Dados $S_{h}^{n}, f_{,S}$ e $\mathbf{v}_{h}$, encontre $S_{h}^{n+1}$ $\in$ $X_{h}$ tal que:
\begin{equation} \label{eq:supgprob1}
F(S_{h}^{n+1}, w_{h}) = 0 \quad \forall w_{h} \in W_{h}
\end{equation}
com
\begin{equation} \label{eq:supgprob2}
X_{h} = \{ S_{h} \in H^{1}(\Omega_{h}); S_{h} \in \mathbf{P}^{1}(E_{i}); \textrm{$S_{h} = S_{D}$ em $\Gamma_{D}$} \}  
\end{equation}
\begin{equation} \label{eq:supgprob3}
W_{h} = \{ w_{h} \in H^{1}(\Omega_{h}); w_{h} \in \mathbf{P}^{k}(E_{i}); \textrm{$w_{h} = 0$ em $\Gamma_{D}$} \}  
\end{equation}
\begin{equation} \label{eq:supgprob4}
\begin{array}{cc}
F(S_{h}^{n+1}, w_{h}) = \int_{\Omega} \left( w \phi \frac{S^{n+1} - S^{n}}{\Delta t} \right) d \Omega + 
\int_{\Omega} wf_{,S}\mathbi{v}^{n+1} \cdot \nabla S^{n+1} d \Omega + \\
\sum\limits_{E_{i}} \int_{E_{i}} \left(\mathbi{v}^{n+1} \cdot \nabla w \right) \tau_{s} r^{n+1} d \Omega
\end{array}
\end{equation}
onde o resíduo $r$ é descrito por:
\begin{equation} \label{eq:residuumsupg2ch3}
r^{n+1} = \phi \frac{S^{n+1} - S^{n}}{\Delta t}+ 
          f_{,S}\mathbi{v}^{n+1} \cdot \nabla S^{n+1}
\end{equation}
\end{problem}

Ao se observar o problema acima, percebe-se que os dois primeiros termos do lado direito da Eq.~(\ref{eq:supgprob4}) correspondem ao que seria obtido através de uma discretização via \ac{MEF} de Galerkin, sendo o terceiro termo o responsável pela estabilização do método através de um somatório das contribuições calculadas elemento por elemento. A consistência da formulação utilizada é garantida pelo fato do termo adicionado ser diretamente proporcional ao resíduo da solução, o qual tende a zero para a resposta exata, cancelando portanto qualquer difusão não-física que poderia ser adicionada neste caso.

O termo $f_{,S}$, que representa a derivada do fluxo fracional em relação à saturação, torna este problema não-linear. Esta não-linearidade pode ser tratada através de diversos métodos, entre eles os métodos de Newton-Raphson e de iteração de Picard. Todavia, neste trabalho foi adotada a mesma estratégia usada por outros autores \citep{Carvalho2005, Silva2008} de linearizar a equação de saturação através do uso do termo $f_{,S}$ calculado no passo de tempo anterior. Esta estratégia tem como vantagem a sua simplicidade, por outro lado requer o uso de passos de tempo pequenos o suficiente para evitar que a linearização do problema degrade a solução.

Existem diversas sugestões na literatura acerca do modo mais adequado de definir o parâmetro de estabilização $\tau_{s}$ \citep{Brooks1982, Barbosa2009, Papastavrou1998, Wells2008}. De um modo geral, este termo está relacionado a uma dimensão característica de malha e à velocidade de transporte, tendo portanto que ser calculado para cada elemento. Neste trabalho optou-se pelo uso da expressão apresentada a seguir \citep{Wells2008}, a qual, apesar de bastante simples comparada a outras encontradas na literatura, normalmente se mostra adequada para problemas altamente hiperbólicos como é o caso da equação da saturação ao se desprezar os termos de capilaridade e gravidade:
\begin{equation} \label{eq:supgstabterm}
\tau_{s} = \frac{h}{2\vert\vert \mathbi{v} \vert\vert}
\end{equation}

\subsubsection{Shock Capture Term}
Apesar do \ac{SUPG} permitir a obtenção de soluções numéricas estáveis em comparação ao \ac{MEF} de Galerkin, o mesmo não garante a inexistência de oscilações em regiões próximas às descontinuidades da solução exata. Isto se explica pelo fato deste método não ser do tipo monótono ou preservador de monotonicidade. Métodos monótonos são aqueles nos quais a solução numérica mantém ao longo do tempo o seu sinal para todos os nós da malha \citep{Codina1992, Papastavrou1998}.

Um meio para garantir uma alta precisão na região de solução suave e ao mesmo tempo evitar o aparecimento de oscilações espúrias na região de choque é utilizar métodos não-lineares, os quais dependem portanto da própria solução do problema. Isto se deve à condição estabelecida pelo teorema de Godunov de que métodos lineares e que preservem a monotonicidade podem ter no máximo uma convergência de primeira ordem \citep{Leveque1992}.

A ideia básica do uso de um termo de captura de choque é adicionar uma dissipação numérica (também chamada de viscosidade artificial) extra na região de descontinuidade. Neste trabalho foi utilizado um termo de dissipação isotrópico, ou seja, que acrescenta a mesma viscosidade em todas as direções \citep{Wells2008}. Todavia, existem na literatura exemplos de usos de termos anisotrópicos \citep{Codina1992, Papastavrou1998}, já que o uso do \ac{SUPG} implica na adição de uma certa viscosidade artificial na direção das linhas de corrente, sendo em princípio necessário acrescentar dissipação apenas na componente perpendicular ao fluxo em cada ponto. Em todo caso, é importante mencionar que assim como na estabilização via \ac{SUPG} a viscosidade artificial adicionada é proporcional ao resíduo da solução, garantindo a consistência do método. Sendo assim, podemos somar o termo seguinte à Eq.~(\ref{eq:supgprob4}) para obter uma nova forma variacional discreta:
\begin{equation} \label{eq:viscartterm1}
\begin{array}{cc}
F(S_{h}^{n+1}, w_{h}) = \int_{\Omega} \left( w \phi \frac{S^{n+1} - S^{n}}{\Delta t} \right) d \Omega + 
\int_{\Omega} wf_{,S}\mathbi{v}^{n+1} \cdot \nabla S^{n+1} d \Omega + \\
\sum\limits_{E_{i}} \int_{E_{i}} \left(\mathbi{v}^{n+1} \cdot \nabla w \right) \tau_{s} r^{n+1} d \Omega + \sum\limits_{E_{i}} \int_{E_{i}} \nu_{shock} \nabla w \cdot \nabla S_{h}^{n+1} d \Omega
\end{array}
\end{equation}%
\nomenclature[a1nu]{$\nu$}{Viscosidade artificial}%
onde $\nu_{shock}$ é a viscosidade artificial definida por:

\begin{equation} \label{eq:viscartterm2}
\nu_{shock} = \left\{ \begin{array}{ll}
  \frac{\beta h \vert r^{n+1} \vert}{2\vert\vert \nabla S_{h}^{n} \vert\vert} & \textrm{se $\vert\vert \nabla S_{h}^{n} \vert\vert \neq 0$}\\
  0 & \textrm{caso contrário}
  \end{array} \right.
\end{equation}
onde $\beta$ é um parâmetro dependente do problema. Neste trabalho foi adotado o valor de $\beta=2.0$, conforme sugestão encontrada na literatura \citep{Wells2008} para problemas de escoamentos em meios porosos.

De modo a exemplificar a influência dos termos tanto de estabilização como de captura de choque, são apresentados a seguir os resultados obtidos para a equação linear de adveção, a qual pode ser vista com uma versão simplificada da Eq.~(\ref{eq:misc1}) com o tensor de difusão e o termo de reação nulos, sendo representada no caso unidimensional pela expressão a seguir:
\begin{equation} \label{eq:hyperpde}
\frac{\partial C(x,t)}{\partial t} = - \mathbi{v}\frac{\partial C(x,t)}{\partial x}
\end{equation}
onde para este exemplo consideramos um vetor velocidade $\mathbi{v}$ unitário na direção $x$ e as seguintes condições iniciais e de contorno:
\begin{equation} \label{eq:hyperpdeconinibc}
\left. \begin{array}{lll}
C(x,0) = 0.0 \quad \textrm{em $\Omega$} \\
C(x,t) = 1.0 \quad \textrm{em $x=0$} \\
\end{array} \right.
\end{equation}

A solução analítica do problema apresentado é uma função degrau com altura $1$ que se desloca na direção positiva do eixo $x$. A Fig.~\ref{fig:puregalerkin} apresenta a solução numérica obtida para o instante de tempo $t=0.5s$ em uma malha unidimensional com 500 elementos lineares utilizando exclusivamente o \ac{MEF} de Galerkin conforme descrito na seção \ref{sc:fem}. Como esperado, a localização da descontinuidade foi resolvida com precisão para este exemplo simples, porém verifica-se o surgimento de oscilações espúrias na região do choque que tendem a crescer indefinidamente, tornando a solução instável.

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/PureGalerkin_t_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} de Galerkin para o caso de advecção pura.}
\label{fig:puregalerkin}
\end{figure}

De modo a estabilizar a solução aplicamos o método \ac{SUPG} descrito na seção \ref{sc:supg} e representado pela Eq.~(\ref{eq:supgprob4}), obtendo o resultado mostrado na Fig.~\ref{fig:supg}, onde pode-se perceber uma eliminação de grande parte da oscilação presente na aproximação numérica inicial. Entretanto, apesar de o choque ter permanecido com uma definição quase tão boa quanto na análise com o \ac{MEF} de Galerkin, ainda se percebe a existência de \emph{overshoots} e \emph{undershoots} na região de descontinuidade.

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/SUPGt_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} com estabilização via \ac{SUPG} para o caso de advecção pura.}
\label{fig:supg}
\end{figure}

Por fim, acrescentamos à formulação o termo de captura de choque com adição de viscosidade artificial conforme descrito pelas Eqs. (\ref{eq:viscartterm1}) e (\ref{eq:viscartterm2}). Como pode ser visto na Fig.~\ref{fig:supg_ad}, a solução numérica se encontra praticamente livre de qualquer oscilação sem que isto tenha afetado a solução nas regiões distante da descontinuidade. Apenas próximo a esta região de maior variação é que pode ser percebida uma maior difusão da solução quando comparada com a analítica, sendo tal consequência esperada devido ao fato de a solução poder ser no máximo de primeira ordem na região de choque conforme previsto pelo teorema de Godunov \citep{Leveque1992}.

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/SUPG+ADt_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} com estabilização via \ac{SUPG} e adição de viscosidade artificial para o caso de advecção pura.}
\label{fig:supg_ad}
\end{figure}

\subsection{Multigrid} \label{sc:multigrid}
% Relatorios de IC / Trottenberg/ Briggs / Mavriplis
The basic idea of Multigrid methods is to accelerate the solution of a equation system in a fine mesh using corrections calculated in a coarser mesh. The motivation for this approach comes from the observation of the numerical solution error behavior in the frequency domain. High frequency errors, which are associated to local variations of the solution, are well resolved by conventional iterative methods (gauss-seidel, conjugated gradients, etc.). However, low frequency error, associated to global variations of the solution, are much more insensitive to these methods.

A Multigrid scheme starts damping the high frequency errors associated to the initial solution in the fine mesh, using some relaxation method (usually an iterative method that would normally be used stand-alone). Once this is achieved, performing more iterations would just result in poorer convergence. Therefore, the error is transfered to a coarser mesh, where the remaining low frequency modes of the finer mesh present themselves as high frequency, thus being easily eliminated using some direct method, in case the mesh is coarse enough, or even using the same relaxation method as before for larger problems. The corrections are then computed in the coarse mesh and transfered back to the fine mesh in order to update the solution. This procedure can be applied recursively in a sequence of increasingly coarser meshes, so that each level in this hierarchy is responsible for the elimination of one error frequency band \citep{Briggs2000}.
% 1- Explicar matematica do multigrid (Relatorio IC) 2 - Explicar GMGxAMG e AMG(Sorensen / Trottenberg)!!

There are two main different approaches for Multigrid methods: the geometric multigrid (GMG), which works directly on the meshes that represent the discrete domain, and the algebraic multigrid (AMG), which operate just on linear systems of equations resulting from the application of a numerical formulation, so that it does not have a direct geometrical interpretation.

The main motivation for the development of the AMG was the necessity for robust and flexible methods for accelerating the convergence without requiring fine tuning for each problem, as is often the case of GMG methods, which requires special attention in the generation of coarse meshes sequences, specially in the presence of complex geometries \citep{Trottenberg2001}. This robustness is achieved because AMG relies on a fully automatic coarsening process that acts only in directions in which the relaxation will effectively smooth the error for the given problem, whereas GMG requires a fixed pre-determined hierarchy before starting its cycle. Figure \ref{fig:gmgxamg} presents a graphical comparison of these two methods.

\begin{figure} 
\centering
\includegraphics[width=1\textwidth]{resultados/GMGxAMG}
\caption{Comparison of Geometrical and Algebraic Multigrid approaches (from \cite{Trottenberg2001}).}
\label{fig:gmgxamg}
\end{figure}

Mathematically, both approaches can be described in almost the same way, it is just necessary to consider that meshes and nodes are linear system of equation and varibles of this system in AMG, respectively. Therefore, the Multigrid method can be briefly described for both approaches as follows:

Consider the system of equations on the finest level:
\begin{equation} \label{eq:mg1}
A_{f}p_{f} = f_{f}
\end{equation}
where $A_{f}$ is the matrix resultant from the procedure described in section \ref{sc:fem} and the subindex $f$ represent values on the fine level. After performing some iterations with a relaxation method, the error will be smoothed and its residual $r_{h}$ is:
\begin{equation} \label{eq:mg2}
A_{f}\hat{p_{f}} - f_{f} = r_{h}
\end{equation}
where $\hat{p_{f}}$ is the estimated solution for the variable of interest. Subtracting Eq. (\ref{eq:mg2}) from Eq. (\ref{eq:mg1}) yields:
\begin{equation} \label{eq:mg3}
A_{f}p_{f} - A_{f}\hat{p_{f}}= - r_{h}
\end{equation}
and if the operator $A_{h}$ is linear, this equation can be presented as a correction equation:
\begin{equation} \label{eq:mg4}
A_{f}\Delta p_{f}= - r_{h}
\end{equation}

Assuming, as already mentioned, that the high frequency modes of the error were already damped after the relaxation on the fine level, the reminiscent correction error will contain mainly low frequency modes and must be also solved, but in order to achieve this it is necessary to restrict it to a coarser level, where it will present itself as a high frequency mode, i.e.
\begin{equation} \label{eq:mg5}
A_{c}\Delta p_{c}= - I_{f}^{c}r_{f}
\end{equation}
In Eq. (\ref{eq:mg5}) $I_{f}^{c}$ represents the restriction operator, which transfer values from the residual in the fine level $f$ to the coarse level $c$. Once Eq. \ref{eq:mg5} is solved by means of an adequate solver (many times a direct solver will suffice, as this level presents lower storage and computation requirements), its solution can be interpolated back to the fine level using a prolongation operator $I_{c}^{f}$ and the original approximation on the fine level can then be corrected:
\begin{equation} \label{eq:mg6}
\hat{p_{f}^{\phantom{.}\ast}} = \hat{p_{f}} + I_{c}^{f} \Delta p_{c}
\end{equation}
where $\hat{p_{f}^{\phantom{.}\ast}}$ is the updated solution on the fine level. It is important to notice that this procedure is intrinsically recursive, so that the system on the coarse level could be seen as a new fine level, being itself smoothed again until some level is reached where the contributions of the corrections on the coarse levels are taken back to their respective fine levels. There are various schemes to handle this strategy, among them are the V-,W- and F-Cycle. Figure \ref{fig:mgcycles} shows a graphical representation of these cycles on a 4-level multigrid solution, see \cite{Briggs2000} or \cite{Trottenberg2001} for a detailed explanation of each of these cycles.

\begin{figure} 
\centering
\includegraphics[width=0.9\textwidth]{resultados/MGCycles}
\caption{V- W- and F-Cycles. $S$ represents smoothing and $E$ is the solution on the coarsest level.}
\label{fig:mgcycles}
\end{figure}

\section{IMPLEMENTATION}
All the computational tools described in this work present great challenges not only in terms of theoretical understanding but also in terms of software development, as it is of paramount importance to adequately implement these methods in a way that a positive trade-off between generality and performance is found, as these two goals often lead the coding directives to different directions.

For the generation of the code responsible for assembling the matrices and vectors necessary for the finite element analysis of the problem we used the \emph{FEniCS/DOLFIN} library \citep{Logg2010}, which allows the developer to write the linear and bilinear forms presented in Eq. (\ref{eq:galerkin}) using a script written in \emph{Python} in a very high-level way, that resembles the mathematical notation,  and this script is then automatically converted in optimized \emph{C++} code, which can run quite effectively for general problems.
% Explicar com MUITO mais detalhe o DOLFIN

The obtained system of equations from the discretization with help of the \emph{FEniCS/DOLFIN} library was solved in this work using an Algebraic Multigrid (AMG) approach utilizing the \emph{PyAMG} package \citep{Bell2008}, which allows one to access a number of multigrid algorithms already implemented through a \emph{Python} interface. The most CPU-intensive routines of this package are implemented and compiled in \emph{C++} for performance purposes, but the user does not have to interface with this lower-level code.
% Explicar com MUITO mais detalhe o PyAMG

\section{RESULTS}

\subsection{Heterogeneous and Anisotropic Medium}
\label{sc:heterogeneoaniso}
This example considers an anisotropic and heterogeneous medium. It was proposed originally in \cite{Crumpton1995} as a benchmark test for elliptic problems and was also analyzed in other works \citep{Hyman1997, Carvalho2005, Silva2008}. The domain $\Omega$ is a $[-1,1]$ x $[-1,1]$ square with Dirichlet boundary conditions given by the exact solution. The permeability coefficient $K$ is defined as:
\begin{equation} \label{eq:coeffheteroaniso}
K = \left\{ \begin{array}{cc}
  \phantom{\alpha}\left( \begin{array}{cc}
1 & 0 \\
0 & 1
\end{array} \right) & \textrm{if $x \leq 0$}\\
  \alpha\left( \begin{array}{ll}
2 & 1 \\
1 & 2
\end{array} \right) & \textrm{if $x > 0$}
  \end{array} \right.
\end{equation}
where $\alpha$ is a parameter used to define the discontinuity intensity in $x = 0$.

The analytical solution (and Dirichlet condition for the boundaries) is given by:
\begin{equation} \label{eq:heteroaniso}
p(x,y) = \left\{ \begin{array}{ll}
  [2\sin(y)+\cos(y)]\alpha x + \sin(y) & \textrm{if $x \leq 0$}\\
  \alpha\exp(x)\sin(y) & \textrm{if $x > 0$}
  \end{array} \right.
\end{equation}
 
Finally, the discontinuous source term is defined as:
\begin{equation} \label{eq:bcheteroaniso}
q(x,y) = \left\{ \begin{array}{ll}
  [-2\sin(y)-\cos(y)]\alpha x - \sin(y) & \textrm{if $x \leq 0$}\\
  2\alpha\exp(x)\cos(y) & \textrm{if $x > 0$}
  \end{array} \right.
\end{equation}

For the problem resolution and convergence rates calculation, it was considered a sequence of successive refined meshes with approximate dimensions of $(8x8)$, $(16x16)$, $(32x32)$, $(64x64)$ e $(128x128)$.
The unstructured mesh used for $N \simeq 8$ and the sub-domains boundary in $x=0$ are showed in Fig. \ref{fig:HeterogeneoAnisoMaterials_N=8}.

\begin{figure}
\centering
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoMaterials_N=8}
\caption{Unstructured mesh with $N \simeq 8$ and discontinuity in $x=0$ for the heterogeneous and anisotropic case.}
\label{fig:HeterogeneoAnisoMaterials_N=8}
\end{figure}

The discontinuity effect on line $x=0$ can be observed in Fig. \ref{fig:HeterogeneoAnisoContour_N=64}, as well as the increase in its intensity as the $\alpha$ parameter is changed. The error maximum and $L2$ norms of the numerical solution when compared to the analytical one are presented on Table \ref{tab:heteroiso}, where can be observed that higher values for the discontinuity in tensor $K$ between the sub-domains implies in an increase of the absolute values obtained for the errors.

\begin{figure}
\centering
\subfigure[$\alpha=1$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoContour_N=64_alpha=1}
}
\quad
\subfigure[$\alpha=10$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoContour_N=64_alpha=10}
}
\quad
\subfigure[$\alpha=100$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoContour_N=64_alpha=100}
}
\quad
\subfigure[$\alpha=1000$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoContour_N=64_alpha=1000}
}
\caption{Scalar pressure field obtained for different discontinuity factors $\alpha$ using the Standard Galerkin FEM in a 64x64 mesh of linear triangles.}
\label{fig:HeterogeneoAnisoContour_N=64}
\end{figure}

\begin{table}
\caption{Error norm and convergence rates for anisotropic and heterogeneous case.}
\centering
\subtable[$\alpha=1$]{
	\begin{tabular}{|c|c|c|c|c|}
	\hline N & \vert\vert E_{max}\vert\vert & q_{max} & \vert\vert E_{L2}\vert\vert & q_{L2} \\
	\hline
	\hline 8 & 5.4e-02 & --- & 4.5e-02 & --- \\ 
	\hline 16 & 2.7e-02 & 0.99 & 2.0e-02 & 1.1 \\ 
	\hline 32 & 1.3e-02 & 1.02 & 9.8e-03 & 1.05 \\ 
	\hline 64 & 6.6e-03 & 1.02 & 4.8e-03 & 1.02 \\ 
	\hline 128 & 3.2e-03 & 1.02 & 2.4e-03 & 1.00 \\ 
	\hline 
	\end{tabular}
	\label{tab:heteroiso1}
}
\qquad\qquad
\subtable[$\alpha=10$]{
	\begin{tabular}{|c|c|c|c|c|}
	\hline N & \vert\vert E_{max}\vert\vert & q_{max} & \vert\vert E_{L2}\vert\vert & q_{L2} \\
	\hline
	\hline 8 & 9.2e-02 & --- & 1.8e-01 & --- \\ 
	\hline 16 & 3.8e-02 & 1.3 & 5.2e-02 & 1.78 \\ 
	\hline 32 & 1.9e-02 & 1.02 & 1.8e-02 & 1.52 \\ 
	\hline 64 & 9.2e-03 & 1.02 & 7.7e-03 & 1.24 \\ 
	\hline 128 & 4.6e-03 & 1.00 & 3.6e-03 & 1.08 \\ 
	\hline 
	\end{tabular}
	\label{tab:heteroiso10}
}
\qquad\qquad
\subtable[$\alpha=100$]{
	\begin{tabular}{|c|c|c|c|c|}
	\hline N & \vert\vert E_{max}\vert\vert & q_{max} & \vert\vert E_{L2}\vert\vert & q_{L2} \\
	\hline
	\hline 8 & 8.6e-01 & --- & 1.7e-00 & --- \\ 
	\hline 16 & 2.9e-01 & 1.59 & 4.3e-01 & 1.98 \\ 
	\hline 32 & 8.8e-02 & 1.70 & 1.1e-01 & 1.98 \\ 
	\hline 64 & 2.5e-02 & 1.79 & 2.8e-02 & 1.94 \\ 
	\hline 128 & 7.2e-03 & 1.81 & 7.9e-03 & 1.84 \\ 
	\hline 
	\end{tabular}
	\label{tab:heteroiso1000}
}
\qquad\qquad
\subtable[$\alpha=1000$]{
	\begin{tabular}{|c|c|c|c|c|}
	\hline N & \vert\vert E_{max}\vert\vert & q_{max} & \vert\vert E_{L2}\vert\vert & q_{L2} \\
	\hline
	\hline 8 & 8.8e-00 & --- & 1.7e+01 & --- \\ 
	\hline 16 & 2.9e-00 & 1.58 & 4.3e-00 & 1.98 \\ 
	\hline 32 & 9.2e-01 & 1.68 & 1.1e-00 & 2.0 \\ 
	\hline 64 & 2.7e-01 & 1.74 & 2.7e-01 & 1.99 \\ 
	\hline 128 & 7.9e-02 & 1.79 & 6.8e-02 & 1.99 \\ 
	\hline 
	\end{tabular}
	\label{tab:heteroiso1000}
}
\label{tab:heteroiso}
\end{table}

An interesting point to be noted is that the values obtained for the numerical solution errors present a convergence rate around 1 for $\alpha = 1$ and $10$, whereas this rate approaches 2 when the discontinuity parameter is increased ($\alpha = 100$ and $1000$).
Comparing this results with those in the references \citep{Crumpton1995,Hyman1997,Carvalho2005,Silva2008}, we notice that methods which perform a local evaluation of the fluxes tend to a convergence rate of 2nd order, while those which work just with the nodal variable (in this case, $p(x,y)$) present a convergence for the error between 1st and 2nd order, in both maximum and $L2$ norms.
One aspect that can contribute for the understanding of this behavior is the error distribution along the domain for various $\alpha$ values. In Fig. \ref{fig:HeterogeneoAnisoError_N=64} can be seen that the error varies smoothly for $\alpha = 1$ and $\alpha = 10$, being concentrated in the discontinuity region, with $x=0$, between the sub-domains. On the other hand, for $\alpha = 100$ e $\alpha = 1000$ the error presents some high frequency modes located mainly in one sub-domain.
This behavior can be explained by the fact that just increasing the $\alpha$ values implies in a higher discontinuity while maintaining the same mesh size, what can be seen as equivalent to keeping the same $\alpha$ and coarsening the mesh, leading to error components with higher frequency modes, independent of its absolute values \citep{Trottenberg2001}.

\begin{figure}
\centering
\subfigure[$\alpha=1$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoError_N=64_alpha=1}
}
\quad
\subfigure[$\alpha=10$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoError_N=64_alpha=10}
}
\quad
\subfigure[$\alpha=100$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoError_N=64_alpha=100}
}
\quad
\subfigure[$\alpha=1000$]{
\includegraphics[width=0.45\textwidth]{resultados/HeterogeneoAnisoError_N=64_alpha=1000}
}
\caption{Anisotropic and heterogenous case. Error distribution for $N \simeq 64$ mesh of linear triangles.}
\label{fig:HeterogeneoAnisoError_N=64}
\end{figure}

The performance of various methods for the solution of the linear system of equations were also compared. Naturally, as this problem is represented by a symmetric positive-definite matrix, it would be a candidate to be solved by conjugated gradient-type methods, whether as stand-alone or as preconditioner with an algebraic multigrid methods. Nonetheless, the following combinations for iterative methods were experimented for this problem:
\begin{itemize}
\item Conjugated Gradients (CG) method applied as stand-alone.
\item Generalized Minimal Residual Method (GMRES) applied as stand-alone.
\item Algebraic Multigrid (AMG) applied as stand-alone.
\item Algebraic Multigrid (AMG) as preconditioner for the Conjugated Gradients method (AMG+CG).
\item Algebraic Multigrid (AMG) as preconditioner for the Generalized Minimal Residual Method (AMG+GMRES).
\end{itemize}

For this numerical experiment, it was considered a 64x64 mesh of linear triangles. The stopping criterion for all methods was a tolerance of $\epsilon = 10^{-10}$, with a maximum number of 200 iterations. The $V$ cycle with a 4-meshes hierarchy was considered for the AMG method.
A residual evolution against iteration number graphic is shown in Fig. \ref{fig:residualHeterogeneoAniso_N=64_alpha=1}, where it can be observed the superiority of multigrid-based methods for this kind of elliptic problem, as even in the presence of heterogenity and anisotropy the AMG stand alone stopped by the maximum number of iterations (200).

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{resultados/residualHeterogeneoAniso_N=64_alpha=1_en}
\caption{Anisotropic and heterogenous case. Residual evolution comparison for $N \simeq 64$ mesh of linear triangles with $\alpha = 1$.}
\label{fig:residualHeterogeneoAniso_N=64_alpha=1}
\end{figure}


\section{CONCLUSIONS}
In this work, a procedure for the solution of the pressure equation in heterogeneous and anisotropic porous media was presented. The PDEs resultant from the mathematical modeling were solved using a Standard Galerkin Finite Element Method approach. In order to accelerate the convergence of the resultant system of equations, an Algebraic Multigrid method was employed, both as stand-alone and as a preconditioner to other solvers. As this kind of numerical framework normally imply in a great time-effort in developing the computational tools that implement them, this work used some available open source libraries in order to automate the generation of low-level code based on some high-level description of the problem. This showed to be a very efficient work methodology, as it allowed to experiment more with the problem in question in less time, because the developer spares time that would be used in "administrative" coding tasks. The results obtained for a model example showed the good performance of the proposed procedure, as the solution converged even for a heterogeneous and highly anisotropic problem. A future work, which is already in progress, will be the solution of the saturation equation associated with the pressure by means of the velocity. The pressure-velocity equation will be solved using a mixed FEM and the saturation equation using a Petrov-Galerkin FEM.

\section{ACKNOWLEDGEMENTS}

The authors thank the Funda\c{c}\~ao de Amparo \`a Ci\^encia do Estado de Pernambuco (FACEPE) and the Conselho Nacional de Desenvolvimento Cient\'ifico e Tecnol\'ogico (CNPq) for the financial support during part of the development of this work.

\section{REFERENCES}

\bibliographystyle{encit2012}
\bibliography{bibfile}

\end{document}
