\chapter{Formulação Numérica}
\label{ch:form_num}

A ideia básica de praticamente todos os métodos numéricos para a solução de \ac{EDP}s é a discretização de um problema contínuo com infinitos graus de liberdade (DOFs) e desse modo redução para um número finito de DOFs. Este problema discreto resulta em um sistema de equações com um número finito de variáveis, o qual normalmente pode ser resolvido utilizando um método adequado (ver seção \ref{sc:multigrid} para detalhes) \citep{Chen2006}.

No \acf{MDF}, o qual ainda é o padrão na simulação numérica de reservatórios, as derivadas das equações originais são simplesmente substituídas por quocientes de diferenças. Os valores das variáveis são definidos apenas por um número específico de pontos, os quais podem estar localizados nos vértices ou no interior das células \citep{Fortuna2000}.

O processo de discretização no caso do \ac{MEF} é diferente na medida em que ele requer a reformulação das \ac{EDP}s em uma forma variacional equivalente. As variáveis desconhecidas para o problema abordado são a pressão e saturação (além da velocidade, para formulações mistas), as quais podem ser descritas em qualquer ponto da região usando uma função de interpolação (também conhecida como função de forma do elemento). Os pontos de suporte para estas funções são os nós da malha, os quais são conectados para formar os elementos.

Neste trabalho, foram experimentados tanto o clássico Método de Elementos Finitos de Galerkin quanto uma formulação dos Métodos dos Elementos Finitos Mistos para resolver a equação da pressão descrita na seção \ref{sc:press_eq}. Para a resolução da equação da saturação (ver seção \ref{sc:eq_sat}) foi utilizado o \ac{MEF} acrescido de um termo de estabilização do tipo \ac{SUPG}. Os resultados destas equações foram acoplados através de um método Sequencial Implícito. Estas metodologias são discutidas nas seções subsequentes e referências são citadas para informações adicionais.

\section{Método dos Elementos Finitos de Galerkin} \label{sc:fem}
A fim de resolver o problema da equação da pressão utilizando o \ac{MEF}, é necessário inicialmente expressar o mesmo na chamada \emph{forma fraca}. O primeiro passo para obter esta nova formulação (também chamada de problema variacional) é multiplicar a \ac{EDP} por uma função $w$%
\nomenclature[awf]{$w$}{Função de ponderação do \ac{MEF}}
chamada de \emph{função de ponderação}, em seguida o resultado é integrado no domínio $\Omega$ e finalmente uma integração por partes é efetuada nos termos com derivadas de segunda ordem \citep{Hughes2000}. A função desconhecida (pressão $p$, por exemplo) é chamada de \emph{função tentativa}. Espaços de funções apropriados devem ser definidos tanto para função de ponderação quanto para a função tentativa.
%Perform the steps above mentioned in a detailed step-by-step presenting the equations
% See Fenics tutorial for reference on that

O problema variacional para a Eq. (\ref{eq:pressure_eq_form3}) considerando todas as hipóteses mencionadas tem a seguinte forma:
\begin{problem} [Contínuo]
Encontre $p$ $\in$ $P$%
\nomenclature[ep]{$P$}{Espaço das funções tentativa para a formulação de Galerkin}
 tal que:
\begin{equation} \label{eq:variational}
A(p,w) = f(w) \quad \forall w \in W
\end{equation}%
\nomenclature[ew]{$W$}{Espaço das funções de ponderação para a formulação de Galerkin}%
com
\begin{equation} \label{eq:funcspace1}
P = \{ p \in H^{1}(\Omega), \textrm{$p = p_{D}$ em $\Gamma_{D}$} \}  
\end{equation}
\begin{equation} \label{eq:funcspace2}
W = \{ w \in H^{1}(\Omega), \textrm{$w = 0$ em $\Gamma_{N}$} \}  
\end{equation}
\begin{equation} \label{eq:bilinearform}
A(p,w) = \int_{\Omega} \lambda K \nabla p \cdot \nabla w d \Omega \quad \forall p,w \in P,W
\end{equation}
\begin{equation} \label{eq:linearform}
f(w) = \int_{\Omega} q_{t}w d \Omega \quad \forall w \in W
\end{equation}
\end{problem}
onde $p_{D}$ é o valor prescrito de $p$ nos contornos de Dirichlet e $H^{1}$%
\nomenclature[eh]{$H^{n}$}{Espaço de Sobolev com derivadas de ordem $n$ quadrado-integráveis}
 é o Espaço de Sobolev de funções com derivadas de primeira ordem quadrado-integráveis. Isto significa que ao passo que a solução da \ac{EDP} tem que existir em um espaço de funções com derivadas contínuas (\emph{forma forte}), o Espaço de Sobolev exigido pela forma fraca permite funções com derivadas descontínuas \citep{Langtangen2010}.
% Explain better about function spaces (Sobolev, L2, etc.). Fenics tutorial good on that
A existência e unicidade da solução deste problema é dada pelo lema de Lax e seu detalhamento completo pode ser encontrado em \cite{Garcia1997}.

% Verify the statement about the velocity on well region and the assumptions made for simplification.
Para a análise via elementos finitos deste problema variacional, é necessário transformar esta formulação contínua definida pela Eq. (\ref{eq:variational}) em um problema discreto. Considere o domínio $\Omega$, o qual é discretizado por $N$ elementos não sobrepostos $E_{i}$ de modo que $\Omega_{h} = \bigcup_{i=1}^{N}E_{i}$ e $E_{i} \cap E_{j} = \emptyset, i \not = j$, onde o subíndice $h$ denota um parâmetro de tamanho característico de malha que representa o problema discretizado.

O problema variacional discreto para a equação de pressão utilizando a abordagem clássica de Galerkin descrita em \cite{Hughes2000} e adotada em vários outros trabalhos \citep{Wells2008, Barbosa2009} é:
\begin{problem} [Discreto]
Encontre $p_{h}$ $\in$ $P_{h}$ tal que:
\begin{equation} \label{eq:galerkin}
A(p_{h},w_{h}) = f(w_{h}) \quad \forall w_{h} \in W_{h}
\end{equation}
com
\begin{equation} \label{eq:funcspace1h}
P_{h} = \{ p_{h} \in H^{1}(\Omega_{h}), p_{h} \in \mathbf{P}^{k}(E_{i}), \textrm{$p_{h} = p_{D}$ em $\Gamma_{D}$} \}  
\end{equation}
\begin{equation} \label{eq:funcspace2h}
W_{h} = \{ w_{h} \in H^{1}(\Omega_{h}), w_{h} \in \mathbf{P}^{k}(E_{i}), \textrm{$w_{h} = 0$ em $\Gamma_{N}$} \}  
\end{equation}
\begin{equation} \label{eq:bilinearformh}
A(p_{h},w_{h}) = \int_{\Omega_{h}} \lambda K \nabla p_{h} \cdot \nabla w_{h} d \Omega \quad \forall p_{h},w_{h} \in P_{h},W_{h}
\end{equation}
\begin{equation} \label{eq:linearformh}
f(w_{h}) = \int_{\Omega_{h}} Q_{t}w_{h} d \Omega \quad \forall w_{h} \in W_{h}
\end{equation}
\end{problem}
onde $\mathbf{P}^{k}(E_{i})$ define funções de forma de Lagrange com ordem $k$ para o elemento finito $E_{i}$. Na Fig. \ref{fig:femtrilinear} são apresentados elementos triangulares para a formulação clássica de Galerkin com diferentes ordens para o polinômio da função de forma, onde pode ser observado que um aumento da ordem de aproximação implica em uma maior quantidade de graus de liberdade por elemento, o que melhora a precisão da interpolação, porém ao custo de um maior tempo computacional. A Eq. (\ref{eq:galerkin}) aplicada a uma malha resulta em um conjunto de equações discretas na variável $p$, cuja solução pode ser obtida usando o métodos descrito na seção \ref{sc:multigrid}.

\begin{figure}
\centering
\subfigure[Triângulo Linear]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/LagTri1}
}
\quad
\subfigure[Triângulo Quadrático]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/LagTri2}
}
\quad
\subfigure[Triângulo Cúbico]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/LagTri3}
}
\caption{Exemplo de elementos triângulares para análise via \ac{MEF}.}
\label{fig:femtrilinear}
\end{figure}

\section{Método dos Elementos Finitos Mistos} \label{sc:mfem}
Na simulação de escoamentos em meios porosos é fundamental se obter uma boa aproximação para a variável de velocidade, pois esta será utilizada para o acoplamento entre as equações de pressão e saturação. Após a utilização de um método numérico como o descrito na seção anterior apenas a variável de pressão estará definida, sendo que esta aproximação será de segunda ordem para elementos triangulares lineares, como os que foram usados na maior parte deste trabalho. Portanto, seria necessário calcular em uma etapa seguinte a velocidade a partir da pressão calculada. 

O modo mais direto de fazer isto seria usar diretamente a equação de Darcy que permite obter o campo de velocidades a partir do gradiente de pressão. Porém, tal alternativa apresenta a grande desvantagem de requerer a diferenciação do campo de pressão, diminuindo a ordem de convergência da aproximação e não garantindo a continuidade da velocidade nas fronteiras, já que um campo contínuo linear de pressão terá o seu gradiente representado como descontínuo entre elementos vizinhos. Uma alternativa, utilizada por vários autores (CITAR PESSOAL DA COPPE), é realizar um pós-processamento ao final do cálculo do campo de pressão para se obter um novo problema variacional na variável de velocidade, o qual ao ser resolvido garante uma melhor ordem de aproximação e a continuidade do campo entre os elementos.

Uma outra alternativa, a qual é apresentada nesta seção, é o uso de uma formulação mista na qual as variáveis de pressão e velocidade são resolvidas simultaneamente. Para isto, é necessário reescrever a  descrição matemática da equação de pressão, subdividindo a mesma em dois problemas, como pode ser visto na Eq. (CITAR EQ. ABAIXO).
% EQs. DE PRESSÂO E VELOCIDADE SEGREGADAS.

\begin{figure}
\centering
\subfigure[Triângulo Linear]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri1}
}
\quad
\subfigure[Triângulo Quadrático]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri2}
}
\quad
\subfigure[Triângulo Cúbico]{
\includegraphics[width=0.35\textwidth]{chapters/ch03/BDMTri3}
}
\caption[Exemplo de elementos triângulares para análise via MEFM.]{Exemplo de elementos triângulares para análise via \ac{MEFM}.}
\label{fig:HeterogeneoAnisoError_N=64}
\end{figure}

\begin{equation} \label{eq:bilinearformhmfem2ch3}
A(p,v,\sigma,\tau) = \int_{\Omega} \left( K^{-1} \lambda^{-1} \sigma \cdot \tau - \nabla \cdot \tau u - \nabla \sigma v \right) d \Omega
\end{equation}
\begin{equation} \label{eq:linearformhmfem2ch3}
f(v) = - \int_{\Omega} fv d \Omega
\end{equation}

% DECRICAO DA DESCRITAZACAO SEGUNDO MFEM. REFERENCIAS EM AARNES, BREZZI e OUTROS.
\section{Estabilização do \ac{MEF} via \ac{SUPG}} \label{sc:supg}
O \ac{MEF} de Galerkin permite obter respostas bastantes acuradas para problemas com soluções suaves, como normalmente é o caso para equações essencialmente elípticas como a equação de pressão. Entretanto, o mesmo não se mostra adequado para a simulação de fenômenos dominados por termos advectivos, caso frequente de equações com características hiperbólicas como a equação de saturação descrita em \ref{sc:eq_sat}. Nestes casos a solução tende a se tornar instável na região de choque, sendo que tal instabilidade é transportada para todo o domínio, deteriorando rapidamente a acurácia global.

Mesmo antes do aparecimento deste problema no contexto do \ac{MEF}, o mesmo já era bastante conhecido do estudo do \ac{MDF}, podendo ser explicado em ambos os casos pelo uso de aproximações que se baseiam no uso de discretizações centradas, ou seja, quando as contribuições vindo de todas as direções possuem o mesmo peso na solução. Inicialmente, uma das técnicas para se contornar este tipo de problema era adicionar um termo artificial de difusão diretamente nas \ac{EDP}s que se desejava aproximar \citep{Papastavrou1998}. Todavia, esta técnica apresenta a desvantagem fundamental de alterar a descrição matemática do problema, ocasionando assim uma perda de consistência, já que mesmo que se utilize uma discretização tendendo ao contínuo continuaria-se obtendo uma resposta que não tenderia à analítica.

Uma solução proposta no contexto do \ac{MDF} consiste na ponderação da solução com um peso maior para a informação que segue a direção do fluxo (esta técnica é comumente conhecida como \emph{Upwinding}). No caso do \ac{MEF}, \cite{Brooks1982} propuseram um método no qual o espaço da função de ponderação não mais corresponde ao espaço da função tentativa utilizada (ou seja, um método do tipo Petrov-Galerkin), sendo adicionado um termo de perturbação com caráter difusivo que atua apenas na direção da linha de fluxo no nível do elemento. Este método, o qual se tornou conhecido pelo nome de \acf{SUPG}, foi extensamente utilizado na literatura para várias aplicações, inclusive na resolução da equação de saturação em escoamentos multifásicos \citep{Barbosa2009, Garcia1997, Loula1995}. Um exemplo desta função de ponderação modificada tem sua representação gráfica mostrada na Fig. \ref{fig:supgweightfunc}, onde se considera um fluxo da esquerda para a direita. Pode ser observado claramente na figura o maior peso considerado para o elemento que está a montante do escoamento quando comparado ao que se encontra a jusante. Isto implica que a modificação a ser efetuada na função de ponderação deve de alguma forma ser dependente da direção do escoamento.

\begin{figure} 
\centering
\includegraphics[width=0.5\textwidth]{chapters/ch03/supgweightfunc}
\caption{Comparação entre diferentes definições da função de ponderação (retirado de \cite{Monajemi2009}).}
\label{fig:supgweightfunc}
\end{figure}

Esta nova função de ponderação para a formulação estabilizada, aqui representada por $w_{s}$, pode ser descrita matematicamente conforme a equação seguinte:
\begin{equation} \label{eq:supgweight}
w_{s} = w + \tau_{s} \mathbf{v} \cdot \nabla w
\end{equation}%
\nomenclature[a1tau]{$\tau$}{Parâmetro de estabilização}%
onde $\mathbf{v}$ representa o vetor velocidade, $w$ a função de ponderação original e $\tau_{s}$ um parâmetro de estabilização que depende do tamanho do elemento e do módulo da velocidade.

Uma vez definida tal função, aplica-se um procedimento semelhante ao utilizado para a discretização pelo Método de Galerkin onde se integra a Eq. (\ref{eq:sateq4}), porém a multiplicação é pela função de ponderação modificada (Eq. (\ref{eq:supgweight})), para se obter depois de algum algebrismo e de modo totalmente consistente a seguinte forma variacional discreta para o problema da equação de saturação \citep{Wells2008}:
\begin{problem} [Discreto]
Dados $S_{h}^{n+1}, f_{,S}$ e $\mathbf{v}_{h}$, encontre $S_{h}^{n+1}$ $\in$ $X_{h}$ tal que:
\begin{equation} \label{eq:supgprob1}
F(S_{h}^{n+1}, w_{h}) = 0 \quad \forall w_{h} \in W_{h}
\end{equation}
com
\begin{equation} \label{eq:supgprob2}
X_{h} = \{ S_{h} \in H^{1}(\Omega_{h}), S_{h} \in \mathbf{P}^{1}(E_{i}), \textrm{$S_{h} = S_{D}$ em $\Gamma_{D}$} \}  
\end{equation}
\begin{equation} \label{eq:supgprob3}
W_{h} = \{ w_{h} \in H^{1}(\Omega_{h}), w_{h} \in \mathbf{P}^{k}(E_{i}), \textrm{$w_{h} = 0$ em $\Gamma_{N}$} \}  
\end{equation}
\begin{equation} \label{eq:supgprob4}
F(S_{h}^{n+1}, w_{h}) = \int_{\Omega} \left( w \phi \frac{S^{n+1} - S^{n}}{\Delta t} \right) d \Omega + 
\int_{\Omega} wf_{,S}\mathbf{v}^{n+1} \cdot \nabla S^{n+1} d \Omega +
\sum\limits_{E_{i}} \int_{E_{i}} \left(\mathbf{v}^{n+1} \cdot \nabla w \right) \tau_{s} r^{n+1} d \Omega
\end{equation}
onde o resíduo $r$ é descrito por:
\begin{equation} \label{eq:residuumsupg2ch3}
r^{n+1} = \phi \frac{S^{n+1} - S^{n}}{\Delta t}+ 
          f_{,S}\mathbf{v}^{n+1} \cdot \nabla S^{n+1}
\end{equation}
\end{problem}

Ao se observar o problema acima, percebe-se que os dois primeiros termos do lado direito da Eq. (\ref{eq:supgprob4}) correspondem ao que seria obtido através de uma discretização via \ac{MEF} de Galerkin, sendo o terceiro termo o responsável pela estabilização do método através de um somatório das contribuições calculadas elemento por elemento. A consistência da formulação utilizada é garantida pelo fato do termo adicionado ser diretamente proporcional ao resíduo da solução, o qual tende a zero para a resposta exata, cancelando portanto qualquer difusão não-física que poderia ser adicionada neste caso.

Existem diversas sugestões na literatura acerca do modo mais adequado de definir o parâmetro de estabilização $\tau_{s}$ \citep{Brooks1982, Barbosa2009, Papastavrou1998, Wells2008}. De um modo geral, este termo está relacionado a uma dimensão característica de malha e à velocidade de transporte, tendo portanto que ser calculado para cada elemento. Neste trabalho optou-se pelo uso da expressão apresentada a seguir, a qual, apesar de bastante simples comparada a outras encontradas na literatura, normalmente se mostra adequada para problemas altamente hiperbólicos como é o caso da equação da saturação ao se desprezar os termos de capilaridade e gravidade:
\begin{equation} \label{eq:supgstabterm}
\tau_{s} = \frac{h}{2\vert\vert \mathbf{v} \vert\vert}
\end{equation}

\subsection{Termo de Captura de Choque}
Apesar do \ac{SUPG} permitir a obtenção de soluções numéricas estáveis em comparação ao \ac{MEF} de Galerkin, o mesmo não garante a inexistência de oscilações em regiões próximas às descontinuidades da solução exata. Isto se explica pelo fato deste método não ser do tipo monótono ou preservador de monotonicidade. Métodos monótonos são aqueles nos quais a solução numérica mantém ao longo do tempo o seu sinal para todos os nós da malha \citep{Codina1992, Papastavrou1998}.

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/PureGalerkin_t_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} de Galerkin para o caso de advecção pura.}
\label{fig:puregalerkin}
\end{figure}

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/SUPGt_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} com estabilização via \ac{SUPG} para o caso de advecção pura.}
\label{fig:supg}
\end{figure}

\begin{figure} 
\centering
\includegraphics[width=0.7\textwidth]{chapters/ch03/SUPG+ADt_n=500}
\caption{Comparação entre solução analítica e numérica considerando o uso do \ac{MEF} com estabilização via \ac{SUPG} e adição de viscosidade artificial para o caso de advecção pura.}
\label{fig:supg_ad}
\end{figure}

\section{Multigrid} \label{sc:multigrid}
% Relatorios de IC / Trottenberg/ Briggs / Mavriplis
A ideia básica dos métodos Multigrid é acelerar a solução de sistemas de equações em uma malha fina usando correções calculadas em uma malha grosseira. A motivação para esta abordagem vem da observação do comportamento do erro da solução numérica no domínio da frequência. Erros de alta frequência, os quais estão associados à variações locais da solução, são bem resolvidos por métodos iterativos convencionais (Gauss-Seidel, Gradientes Conjugados, etc.). Entretanto, erros de baixa frequência, associados à variação global das soluções, são muito mais insensíveis a esses métodos.

Um esquema Multigrid começa amortecendo os erros de alta frequência associados à solução inicial na malha fina, usando algum tipo de método de relaxação (usualmente um método iterativo que seria usado isoladamente). Uma vez atingido este objetivo inicial, efetuar mais iterações iria apenas resultar em uma pior convergência. Sendo assim, o resíduo é transferido para uma malha grosseira, onde os modos de baixa frequência da malha fina se comportam como de alta frequência, sendo, portanto, facilmente eliminados usando algum tipo de método direto, no caso da malha ser grosseira o suficiente, ou mesmo usando o mesmo método de relaxação aplicado na malha mais fina. As correções são então calculadas na malha grosseira e transferidos de volta para a malha fina de modo a atualizar a solução. Este procedimento pode ser aplicado recursivamente em uma sequência de malhas cada vez mais grosseiras, a fim de que cada nível nesta hierarquia seja responsável pela eliminação de uma faixa de frequência de erro \citep{Briggs2000}. 
% 1- Explicar matematica do multigrid (Relatorio IC) 2 - Explicar GMGxAMG e AMG(Sorensen / Trottenberg)!!

Existem dois tipos principais de método Multigrid: o \ac{GMG}, o qual trabalha diretamente nas malhas que representam o domínio discreto, e o Multigrid Algébrico (AMG), o qual opera apenas no sistema de equações lineares resultantes da aplicação de uma formulação numérica, não tendo portanto uma interpretação geométrica direta.

A maior motivação para o desenvolvimento do \ac{AMG} foi a necessidade de métodos robustos e flexíveis para acelerar a convergência sem a exigência de calibração fina para cada problema, como é frequentemente o caso para métodos \ac{GMG}, o qual requer atenção especial na geração da sequência de malhas grosseiras, principalmente na presença de geometrias complexas \citep{Trottenberg2001}. Esta robustez é alcançada porque o \ac{AMG} conta com um processo totalmente automático para gerar os ``subproblemas'' mais grosseiros, o qual pode agir apenas nas direções nas quais a relaxação irá efetivamente suavizar o erro para o problema dado, enquanto o \ac{GMG} requer uma hierarquia fixa pré-determinada antes de começar o ciclo. A Fig. \ref{fig:gmgxamg} apresenta uma comparação gráfica destes dois métodos.

\begin{figure} 
\centering
\includegraphics[width=1\textwidth]{chapters/ch03/GMGxAMG}
\caption{Comparação dos métodos Multigrid Geométrico e Algébrico (retirado de \cite{Trottenberg2001}).}
\label{fig:gmgxamg}
\end{figure}

Matematicamente, ambas as abordagens podem ser descritas aproximadamente do mesmo modo, é apenas necessário considerar que malhas e nós no \ac{AMG} são sistemas de equações lineares e variáveis destes sistemas, respectivamente. Portanto, o método Multigrid pode ser brevemente descrito como segue:

Considere o sistema de equações no nível mais refinado:
\begin{equation} \label{eq:mg1}
\mathbi{A}_{f}p_{f} = \mathbi{f}_{f}
\end{equation}
onde $\mathbi{A}_{f}$%
\nomenclature[cam]{$\mathbi{A}$}{Matriz resultante da discretização via \ac{MEF}}%
\nomenclature[bfc]{$\mathbi{f}$}{Vetor de carregamentos}%
\nomenclature[df]{$f$}{Relativo ao nível mais refinado}
 é a matriz resultante dos procedimentos descritos na seções \ref{sc:fem} a \ref{sc:supg} e o subíndice $f$ representa valores no nível refinado. Depois de efetuadas algumas iterações com um método de relaxação, o erro estará suavizado e seu resíduo $r_{h}$ %
\nomenclature[are]{$r$}{Resíduo da solução aproximada}%
será: 
\begin{equation} \label{eq:mg2}
\mathbi{A}_{f}\hat{p_{f}} - \mathbi{f}_{f} = r_{f}
\end{equation}
onde  $\hat{p_{f}}$ é a solução estimada para a variável de interesse. Subtraindo a Eq. (\ref{eq:mg2}) da Eq. (\ref{eq:mg1}) resulta:
\begin{equation} \label{eq:mg3}
\mathbi{A}_{f}p_{f} - \mathbi{A}_{f}\hat{p_{f}}= - r_{f}
\end{equation}
e se o operador $\mathbi{A}$ for linear, esta equação pode ser apresentada como a equação de correção:
\begin{equation} \label{eq:mg4}
\mathbi{A}_{f}\Delta p_{f}= - r_{f}
\end{equation}

Assumindo, como já mencionado, que os modos de alta frequência do erro foram amortecidos depois da relaxação no nível mais refinado, o erro remanescente irá conter basicamente modos de baixa frequência que devem ser resolvidos, mas de modo a alcançar tal objetivo é necessário restringir tais modos ao nível grosseiro, onde os mesmos irão se comportar como modos de alta frequência, ou seja:
\begin{equation} \label{eq:mg5}
\mathbi{A}_{c}\Delta p_{c}= - \mathbi{I}_{f}^{c}r_{f}
\end{equation}
Na Eq. (\ref{eq:mg5}) $\mathbi{I}_{f}^{c}$ %
\nomenclature[cio]{$\mathbi{I}$}{Operador de transferência entre níveis}%
representa o operador de restrição, o qual transfere valores do resíduo do nível refinado $f$ para o nível grosseiro $c$%
\nomenclature[dc]{$c$}{Relativo ao nível menos refinado}
. Uma vez que a Eq. (\ref{eq:mg5}) é resolvida adequadamente (frequentemente, se o nível for muito grosseiro, um resolvedor direto será suficiente, já que este nível apresenta menores exigência de processamento e armazenamento), sua solução pode ser interpolada de volta para o nível refinado usando um operador de prolongamento $\mathbi{I}_{c}^{f}$ e a aproximação original no nível refinado pode então ser corrigida:
\begin{equation} \label{eq:mg6}
\hat{p_{f}^{\phantom{.}\ast}} = \hat{p_{f}} + \mathbi{I}_{c}^{f} \Delta p_{c}
\end{equation}
onde $\hat{p_{f}^{\phantom{.}\ast}}$ é a solução atualizada no nível refinado. É importante observar que este procedimento é intrinsecamente recursivo, podendo o sistema no nível grosseiro ser visto como um novo nível refinado, sendo suavizado novamente até que seja atingido um nível no qual as contribuições das correções nos níveis grosseiros sejam trazidas de volta para os seus respectivos níveis refinados. Existem diversos tipos de esquemas para lidar com esta estratégia, entre eles estão os ciclos V, W e F. A Fig. \ref{fig:mgcycles} mostra uma representação gráfica destes ciclos em um esquema Multigrid de 4 níveis, ver \cite{Briggs2000} ou \cite{Trottenberg2001} para uma explicação mais detalhada de cada um destes ciclos.
% Keep the references, but explain in the thesis also much more about the cycles (see Sorensen for examples, has also some
% estimation of computing and storage requirements for each cycle).

\begin{figure} 
\centering
\includegraphics[width=0.9\textwidth]{chapters/ch03/MGCycles}
\caption{Ciclos V, W e F. $S$ representa suavização e $E$ é a solução no nível mais grosseiro.}
\label{fig:mgcycles}
\end{figure}
